<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>{% if setup_mode %}Create Your Store — IZZA PAY{% else %}Merchant Dashboard — {{ m['business_name'] }}{% endif %}</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    body{font-family:Arial,Helvetica,sans-serif;background:#0b0f17;color:#e8f0ff;margin:0}
    .wrap{max-width:1000px;margin:0 auto;padding:16px}
    h1,h2{margin:10px 0}
    .card{background:#0f1728;border:1px solid #1f2a44;border-radius:12px;padding:16px;margin:12px 0}
    .row{display:flex;gap:16px;flex-wrap:wrap}
    .col{flex:1 1 320px}
    label{display:block;margin:8px 0 4px}
    input,textarea,select{width:100%;padding:10px;border-radius:10px;border:1px solid #26324d;background:#101828;color:#e8f0ff}
    button{background:#6e9fff;color:#0b0f17;border:0;border-radius:10px;padding:10px 16px;font-weight:700;margin-top:10px}
    .muted{color:#bcd0ff;opacity:.9}
    .product{display:flex;gap:12px;align-items:center}
    .product img{width:72px;height:72px;object-fit:cover;border-radius:10px;border:1px solid #1f2a44;background:#0b0f17}
    .inline{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;font-size:.9rem}
    .copybtn{background:#1f2a44;color:#cfe0ff}
    .error{color:#ff9aa2;margin:8px 0}
  </style>
</head>
<body>
<div class="wrap">
  {% if setup_mode %}
    <h1>Create your merchant profile</h1>
    <div class="card">
      {% if error %}<div class="error">{{ error }}</div>{% endif %}
      <form method="POST" action="/merchant/setup">
        <div class="row">
          <div class="col">
            <label>Store Name</label>
            <input name="business_name" placeholder="e.g., Toronto Sport Cards" required>
            <label>Store Slug (URL)</label>
            <input name="slug" placeholder="e.g., toronto-sport-cards">
            <label>Logo URL (https)</label>
            <input name="logo_url" placeholder="https://...">
          </div>
          <div class="col">
            <label>Theme</label>
            <select name="theme_mode">
              <option value="dark">Dark</option>
              <option value="light">Light</option>
            </select>
            <label>Merchant Contact Email (for order emails)</label>
            <input name="reply_to_email" type="email" placeholder="name@business.com">
            <label>Pi Wallet Public Key (56 chars, starts with G)</label>
            <input name="pi_wallet_address" placeholder="G................................................." required>
            <label>Pi Handle (optional)</label>
            <input name="pi_handle" placeholder="@yourhandle">
          </div>
        </div>
        {% if t %}<input type="hidden" name="t" value="{{ t }}">{% endif %}
        <button type="submit">Create Merchant</button>
      </form>
    </div>
  {% else %}
    <div class="inline">
      <img src="{{ m['logo_url'] }}" alt="" style="height:36px;border-radius:8px;border:1px solid #1f2a44">
      <h1 style="margin:0">{{ m['business_name'] }}</h1>
    </div>

    <div class="card">
      <h2>Your Storefront</h2>
      <p class="muted">This is the **single link** you give customers or place on your website navigation to show all items payable with Pi.</p>
      <div class="inline">
        <input class="mono" id="storeUrl" value="{{ request.host_url }}store/{{ m['slug'] }}" readonly>
        <button class="copybtn" onclick="copy('storeUrl')">Copy</button>
        <a href="/store/{{ m['slug'] }}" target="_blank"><button>Open</button></a>
      </div>
    </div>

    <div class="card">
      <h2>Add a Product</h2>
      <form method="POST" action="/merchant/{{ m['slug'] }}/items/new">
        <div class="row">
          <div class="col">
            <label>Title</label>
            <input name="title" required placeholder="e.g., 2024 Pro Pack">
            <label>SKU (optional)</label>
            <input name="sku" placeholder="SKU-1234">
            <label>Image URL (https)</label>
            <input name="image_url" placeholder="https://cdn.shopify.com/s/files/.../image.png?v=...">
          </div>
          <div class="col">
            <label>Price (Pi)</label>
            <input name="pi_price" type="number" step="0.000001" min="0" required>
            <label>Stock Qty</label>
            <input name="stock_qty" type="number" min="0" value="0">
            <label>
              <input type="checkbox" name="allow_backorder"> Allow backorder
            </label>
          </div>
        </div>
        {% if t %}<input type="hidden" name="t" value="{{ t }}">{% endif %}
        <button type="submit">Add Product</button>
      </form>
    </div>

    <div class="card">
      <h2>Your Products</h2>
      {% if items %}
        <div class="row">
          {% for it in items %}
          <div class="col">
            <div class="product">
              <img src="/uimg?src={{ (it['image_url'] or '')|urlencode }}" onerror="this.src='https://via.placeholder.com/72?text=PI'">
              <div>
                <div style="font-weight:800">{{ it['title'] }}</div>
                <div class="muted">{{ '%.6f'|format(it['pi_price']) }} Pi • Stock: {{ it['stock_qty'] }}</div>
                <div class="inline" style="margin-top:6px">
                  <a href="/checkout/{{ it['link_id'] }}" target="_blank"><button>Direct checkout</button></a>
                  <input class="mono" id="link-{{ it['id'] }}" value="{{ request.host_url }}checkout/{{ it['link_id'] }}" readonly>
                  <button class="copybtn" onclick="copy('link-{{ it['id'] }}')">Copy</button>
                </div>
              </div>
            </div>
          </div>
          {% endfor %}
        </div>
      {% else %}
        <p class="muted">No products yet. Add your first one above.</p>
      {% endif %}
    </div>

  {% endif %}
</div>

<script>
function copy(id){
  const el = document.getElementById(id);
  el.select(); el.setSelectionRange(0, 99999);
  document.execCommand("copy");
}
</script>
</body>
</html>
