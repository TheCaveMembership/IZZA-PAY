<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>{% if setup_mode %}Create your IZZA PAY Store{% else %}Merchant Items{% endif %}</title>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
  <link rel="stylesheet" href="/static/themes.css">
  <style>
    html,body{max-width:100%;overflow-x:hidden;}
    body{font-family:Arial,Helvetica,sans-serif;margin:0}

    .wrap{max-width:960px;margin:0 auto;padding:16px}
    @media (min-width:640px){ .wrap{padding:24px} }

    .topbar{
      display:flex;align-items:center;justify-content:space-between;gap:8px;flex-wrap:wrap;
      padding:8px 0; position:sticky; top:0; z-index:10;
      background:rgba(11,15,23,.9); backdrop-filter:blur(8px); border-bottom:1px solid var(--line);
    }
    .brand{display:flex;align-items:center;gap:10px;min-width:0}
    .brand img{height:24px}
    .actions{display:flex;gap:8px;flex-wrap:wrap}
    .actions a{white-space:nowrap}

    .grid{display:grid; gap:12px; grid-template-columns: 1fr;}
    @media (min-width:900px){ .grid{ grid-template-columns: 380px 1fr; align-items:start; } }

    .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:14px}
    .h1{font-size:24px;font-weight:800;margin:2px 0 10px}
    .muted{color:var(--muted)}

    .row{display:flex;gap:10px;flex-wrap:wrap}
    .stack{display:flex;flex-direction:column;gap:8px}

    .field{display:flex;flex-direction:column;gap:6px}
    .field-inline{display:grid;gap:10px;grid-template-columns:1fr}
    @media (min-width:600px){ .field-inline{grid-template-columns:1fr 1fr} }
    .ip-input,.ip-select,.ip-textarea{width:100%}

    .pickers{ display:grid; gap:12px; grid-template-columns:1fr; }
    @media (min-width:700px){ .pickers{ grid-template-columns:1fr 1fr; } }
    .picker .thumb{
      width:100%; height:120px; border:1px solid var(--line); border-radius:10px;
      background:#fff; display:flex; align-items:center; justify-content:center; overflow:hidden;
    }
    .picker .thumb img{ width:100%; height:100%; object-fit:cover }

    .itimg{ width:80px;height:80px;border:1px solid var(--line);border-radius:10px;background:#fff;overflow:hidden;display:flex;align-items:center;justify-content:center }
    .itimg img{width:100%;height:100%;object-fit:cover}

    table{width:100%;border-collapse:collapse}
    th,td{padding:8px;border-bottom:1px solid var(--line);text-align:left}
    th{color:var(--muted);font-weight:600}

    .theme-swatches{display:flex;gap:10px;flex-wrap:wrap}
    .swatch{
      width:120px; padding:8px; border:1px solid var(--line); border-radius:10px; cursor:pointer;
      display:flex; flex-direction:column; gap:6px; align-items:center; background:var(--card)
    }
    .swatch .preview{ width:100%; height:60px; border-radius:8px; border:1px solid var(--line); }
    .swatch small{color:var(--muted)}
  </style>
</head>
<body class="cw-blue theme-a">
  <div class="wrap">

    <div class="topbar">
      <div class="brand">
        <img src="/static/izzapay-mark.svg" alt="IZZA mark">
        <img src="/static/izzapay-word.svg" alt="IZZA PAY">
      </div>
      <div class="actions">
        <a class="ip-btn ghost" href="/explore">View Stores</a>
        <a class="ip-btn ghost" href="/logout">Log out</a>
      </div>
    </div>

    {% if setup_mode %}
      <div class="h1">Create your IZZA PAY Store</div>
      {% if username %}
        <p class="muted" style="margin-top:-6px">Signed in as <strong>@{{ username }}</strong></p>
      {% endif %}

      {% if error %}
        <div class="card" style="border-color:#7a2c2c;background:rgba(122,44,44,.15);margin-bottom:10px">
          <div>{{ error }}</div>
        </div>
      {% endif %}

      <!-- IMPORTANT: carry token t so auth persists -->
      <form class="grid" method="post" action="/merchant/setup">
        <input type="hidden" name="t" value="{{ t or '' }}">

        <div class="card stack">
          <div class="field">
            <label class="ip-label">Store name</label>
            <input class="ip-input" name="business_name" placeholder="Your store name">
          </div>

          <div class="field">
            <label class="ip-label">Store slug (optional)</label>
            <input class="ip-input" name="slug" placeholder="your-handle">
            <small class="muted">Your storefront URL will be <code>/store/&lt;slug&gt;</code>.</small>
          </div>

          <div class="field">
            <label class="ip-label">Order notifications email</label>
            <input class="ip-input" name="reply_to_email" placeholder="you@example.com">
          </div>

          <div class="field">
            <label class="ip-label">Pi wallet public key</label>
            <input class="ip-input" name="pi_wallet_address" placeholder="G… (56 characters)">
          </div>

          <div class="field">
            <label class="ip-label">Pi handle (optional)</label>
            <input class="ip-input" name="pi_handle" placeholder="@your-pi-handle">
          </div>

          <div class="field">
            <label class="ip-label">Theme mode</label>
            <select class="ip-select" name="theme_mode">
              <option value="dark" selected>Dark</option>
              <option value="light">Light</option>
            </select>
          </div>

          <div class="field">
            <label class="ip-label">Images</label>
            <div class="pickers">
              <div class="picker card">
                <div class="muted" style="font-weight:600;margin-bottom:6px">Logo</div>
                <div class="thumb" id="logoThumb"><span class="muted">Preview</span></div>
                <div class="row">
                  <input type="file" id="logoFile" accept="image/*" style="flex:1" />
                  <button class="ip-btn" type="button" id="logoUploadBtn">Upload</button>
                </div>
                <div class="field" style="margin-top:6px">
                  <input class="ip-input" id="logoUrl" name="logo_url" placeholder="https://… (or paste a logo URL)">
                </div>
              </div>

              <div class="picker card">
                <div class="muted" style="font-weight:600;margin-bottom:6px">Banner (optional)</div>
                <div class="thumb" id="bannerThumb"><span class="muted">Preview</span></div>
                <div class="row">
                  <input type="file" id="bannerFile" accept="image/*" style="flex:1" />
                  <button class="ip-btn" type="button" id="bannerUploadBtn">Upload</button>
                </div>
                <div class="field" style="margin-top:6px">
                  <input class="ip-input" id="bannerUrl" name="banner_url" placeholder="https://… (or paste a banner URL)">
                </div>
              </div>
            </div>
          </div>

          <div class="row" style="justify-content:flex-end;margin-top:4px">
            <button class="ip-btn" type="submit">Save &amp; Continue</button>
          </div>
        </div>

        <div class="card stack">
          <div class="muted" style="font-weight:600">Look &amp; Feel</div>
          <div class="theme-swatches">
            <div class="swatch" data-cw="cw-blue">
              <div class="preview theme-preview cw-blue theme-a">
                <div class="blk"></div><div class="blk"></div><div class="blk"></div>
              </div><small>Blue</small>
            </div>
            <div class="swatch" data-cw="cw-mint">
              <div class="preview theme-preview cw-mint theme-a">
                <div class="blk"></div><div class="blk"></div><div class="blk"></div>
              </div><small>Mint</small>
            </div>
            <div class="swatch" data-cw="cw-purple">
              <div class="preview theme-preview cw-purple theme-a">
                <div class="blk"></div><div class="blk"></div><div class="blk"></div>
              </div><small>Purple</small>
            </div>
            <div class="swatch" data-cw="cw-amber">
              <div class="preview theme-preview cw-amber theme-a">
                <div class="blk"></div><div class="blk"></div><div class="blk"></div>
              </div><small>Amber</small>
            </div>
          </div>
          <p class="muted" style="margin-top:8px">
            These previews help you choose a vibe. Actual storefront layout can be switched later.
          </p>
        </div>
      </form>

    {% else %}
      <div class="h1">{{ m.business_name }}</div>

      <div class="card">
        <form class="stack" method="post" action="/merchant/{{ m.slug }}/items/new">
          <!-- carry token on item creation, too -->
          <input type="hidden" name="t" value="{{ t or '' }}">
          <div class="field-inline">
            <div class="field">
              <label class="ip-label">Title</label>
              <input class="ip-input" name="title" required>
            </div>
            <div class="field">
              <label class="ip-label">SKU</label>
              <input class="ip-input" name="sku">
            </div>
          </div>

          <div class="field">
            <label class="ip-label">Image</label>
            <div class="row" style="gap:8px;align-items:center">
              <div class="itimg" id="itThumb"><span class="muted" style="font-size:12px">Preview</span></div>
              <input type="file" id="itFile" accept="image/*" />
              <button type="button" class="ip-btn" id="itUploadBtn">Upload</button>
            </div>
            <input class="ip-input" id="itUrl" name="image_url" placeholder="https://… (or paste an image URL)">
          </div>

          <div class="field-inline">
            <div class="field">
              <label class="ip-label">Price (Pi)</label>
              <input class="ip-input" name="pi_price" inputmode="decimal" placeholder="0.1" required>
            </div>
            <div class="field">
              <label class="ip-label">Stock Qty</label>
              <input class="ip-input" name="stock_qty" inputmode="numeric" placeholder="10">
            </div>
          </div>

          <div class="row" style="justify-content:space-between;align-items:center">
            <label class="ip-label" style="display:flex;gap:6px;align-items:center">
              <input type="checkbox" name="allow_backorder" value="1"> Allow backorder
            </label>
            <button class="ip-btn" type="submit">Add Item</button>
          </div>
        </form>
      </div>

      <div class="card" style="margin-top:12px;overflow:auto">
        <table>
          <thead>
            <tr><th>Image</th><th>Title</th><th>Price (Pi)</th><th>Stock</th><th>Link</th></tr>
          </thead>
          <tbody>
          {% for it in items %}
            <tr>
              <td>
                <div class="itimg">
                  {% if it.image_url %}
                    <img src="/uimg?src={{ it.image_url | urlencode }}" alt="">
                  {% else %}
                    <span class="muted" style="font-size:12px">—</span>
                  {% endif %}
                </div>
              </td>
              <td>{{ it.title }}</td>
              <td>{{ '%.7f'|format(it.pi_price) }}</td>
              <td>{{ it.stock_qty }}</td>
              <td><code>/checkout/{{ it.link_id }}</code></td>
            </tr>
          {% endfor %}
          </tbody>
        </table>
      </div>
    {% endif %}
  </div>

  <script>
  function setThumb(id, url){
    const el = document.getElementById(id);
    if(!el) return; el.innerHTML = '';
    const img = document.createElement('img'); img.src = url; el.appendChild(img);
  }
  async function uploadTo(path, file){
    const fd = new FormData(); fd.append('file', file);
    const r = await fetch('/upload', {method:'POST', body:fd});
    if(!r.ok) throw new Error('upload failed'); const j = await r.json();
    if(!j.ok || !j.url) throw new Error('bad response'); return j.url;
  }

  (function(){
    const file = document.getElementById('logoFile');
    const btn  = document.getElementById('logoUploadBtn');
    const inp  = document.getElementById('logoUrl');
    if(!file || !btn || !inp) return;
    btn.addEventListener('click', async () => {
      if(!file.files || !file.files[0]){ inp.focus(); return; }
      btn.disabled = true; btn.textContent = 'Uploading…';
      try{ const url = await uploadTo('/upload', file.files[0]); inp.value = url; setThumb('logoThumb', url); }
      catch(e){ alert('Upload failed. You can paste a URL instead.'); }
      finally{ btn.disabled = false; btn.textContent = 'Upload'; }
    });
    inp.addEventListener('input', () => { const v = inp.value.trim(); if(v) setThumb('logoThumb', v); });
  })();

  (function(){
    const file = document.getElementById('bannerFile');
    const btn  = document.getElementById('bannerUploadBtn');
    const inp  = document.getElementById('bannerUrl');
    if(!file || !btn || !inp) return;
    btn.addEventListener('click', async () => {
      if(!file.files || !file.files[0]){ inp.focus(); return; }
      btn.disabled = true; btn.textContent = 'Uploading…';
      try{ const url = await uploadTo('/upload', file.files[0]); inp.value = url; setThumb('bannerThumb', url); }
      catch(e){ alert('Upload failed. You can paste a URL instead.'); }
      finally{ btn.disabled = false; btn.textContent = 'Upload'; }
    });
    inp.addEventListener('input', () => { const v = inp.value.trim(); if(v) setThumb('bannerThumb', v); });
  })();

  (function(){
    const file = document.getElementById('itFile');
    const btn  = document.getElementById('itUploadBtn');
    const inp  = document.getElementById('itUrl');
    if(!file || !btn || !inp) return;
    btn.addEventListener('click', async () => {
      if(!file.files || !file.files[0]){ inp.focus(); return; }
      btn.disabled = true; btn.textContent = 'Uploading…';
      try{ const url = await uploadTo('/upload', file.files[0]); inp.value = url; setThumb('itThumb', url); }
      catch(e){ alert('Upload failed. You can paste a URL instead.'); }
      finally{ btn.disabled = false; btn.textContent = 'Upload'; }
    });
    inp.addEventListener('input', () => { const v = inp.value.trim(); if(v) setThumb('itThumb', v); });
  })();

  (function(){
    const swatches = document.querySelectorAll('.swatch');
    swatches.forEach(sw => {
      sw.addEventListener('click', () => {
        document.body.classList.remove('cw-blue','cw-mint','cw-purple','cw-amber');
        const cw = sw.getAttribute('data-cw'); if(cw) document.body.classList.add(cw);
      });
    });
  })();
  </script>
</body>
</html>
