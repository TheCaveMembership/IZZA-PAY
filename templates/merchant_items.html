<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>{{ 'Create your IZZA PAY Store' if setup_mode else (m.business_name ~ ' — Dashboard') }}</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    :root{--bg:#0b0f17;--card:#0f1728;--line:#1f2a44;--txt:#e8f0ff;--muted:#bcd0ff;--brand:#6e9fff;--ok:#73e2a7;--bad:#ff9aa2}
    body{font-family:Arial,Helvetica,sans-serif;background:var(--bg);color:var(--txt);margin:0}
    .wrap{max-width:1024px;margin:0 auto;padding:16px}
    .row{display:flex;gap:16px;align-items:center}
    .col{display:flex;flex-direction:column;gap:10px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:14px;margin-bottom:12px}
    h1{margin:0 0 8px}
    h2{margin:8px 0}
    label{font-size:13px;color:var(--muted);display:block;margin-bottom:4px}
    input[type="text"], input[type="number"], input[type="email"], textarea, select{
      width:100%;border:1px solid var(--line);background:var(--bg);color:var(--txt);
      border-radius:10px;padding:10px
    }
    textarea{min-height:80px}
    .btn{background:var(--brand);color:#fff;border:0;border-radius:10px;padding:10px 12px;font-weight:800;cursor:pointer}
    .btn.out{background:transparent;color:var(--brand);border:1px solid var(--brand)}
    .btn.danger{background:transparent;color:var(--bad);border:1px solid var(--bad)}
    .muted{color:var(--muted)}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .thumb{width:100%;aspect-ratio:3/1;border:1px solid var(--line);border-radius:10px;overflow:hidden;background:#101826;display:flex;align-items:center;justify-content:center}
    .thumb img{width:100%;height:100%;object-fit:cover}
    .logo{width:140px;height:48px;border:1px solid var(--line);border-radius:10px;background:#fff;display:flex;align-items:center;justify-content:center;overflow:hidden}
    .logo img{max-height:100%;max-width:100%;object-fit:contain}
    .stack{display:flex;flex-direction:column;gap:8px}
    .themes{display:grid;grid-template-columns:repeat(4,1fr);gap:8px}
    .themeOpt{border:1px solid var(--line);border-radius:10px;padding:8px;cursor:pointer;background:#0c1424}
    .themeOpt.sel{outline:2px solid var(--brand)}
    .cways{display:flex;flex-wrap:wrap;gap:8px}
    .swatch{width:30px;height:30px;border-radius:999px;border:2px solid var(--line);cursor:pointer;display:inline-block}
    .swatch.sel{outline:2px solid var(--brand)}
    .fonts{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}
    .fopt{border:1px solid var(--line);border-radius:10px;padding:10px;cursor:pointer;background:#0c1424}
    .fopt.sel{outline:2px solid var(--brand)}
    .items{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .item{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:10px}
    .itthumb{width:100%;aspect-ratio:1/1;border:1px solid var(--line);border-radius:10px;overflow:hidden;background:#fff;display:flex;align-items:center;justify-content:center;margin-bottom:8px}
    .itthumb img{width:100%;height:100%;object-fit:cover}
    .rowsp{display:flex;gap:8px;align-items:center;justify-content:space-between}
    .err{color:var(--bad);white-space:pre-wrap}
    .good{color:var(--ok)}
    .copy{display:flex;gap:6px;align-items:center}
    .right{margin-left:auto}
    .note{font-size:12px;color:var(--muted)}
    @media(max-width:840px){ .grid,.items{grid-template-columns:1fr} }
  </style>
  <script>
    // little helper to copy text
    function copyText(txt){
      navigator.clipboard.writeText(txt).then(()=>alert("Copied!")).catch(()=>{});
    }
    async function uploadTo(path){
      const inp = document.getElementById(path);
      const file = inp?.files?.[0];
      if(!file) return;
      const fd = new FormData();
      fd.append('file', file);
      const res = await fetch('/upload', { method:'POST', body: fd });
      const json = await res.json();
      if(json && json.ok && json.url){
        const target = document.querySelector('[data-bind="'+path+'"]');
        if(target){ target.value = json.url; target.dispatchEvent(new Event('input')); }
      }else{
        alert('Upload failed');
      }
    }
    // pickers
    function pickTheme(val){
      document.getElementById('theme').value = val;
      document.querySelectorAll('.themeOpt').forEach(n=>n.classList.toggle('sel', n.dataset.v===val));
    }
    function pickColor(v){
      document.getElementById('colorway').value = v;
      document.querySelectorAll('.swatch').forEach(n=>n.classList.toggle('sel', n.dataset.v===v));
    }
    function pickFont(f,url){
      document.getElementById('font_family').value = f;
      document.getElementById('font_url').value = url||'';
      document.querySelectorAll('.fopt').forEach(n=>n.classList.toggle('sel', n.dataset.v===f));
    }
  </script>
</head>
<body>
  <div class="wrap">
    {% if setup_mode %}
      <div class="card">
        <h1>Create your IZZA PAY Store</h1>
        <p class="muted">Signed in as <strong>@{{ username }}</strong></p>
      </div>
    {% else %}
      <div class="card row" style="justify-content:space-between">
        <div>
          <h1>{{ m.business_name }} — Dashboard</h1>
          <div class="muted">Storefront: <a href="/store/{{ m.slug }}{% if t %}?t={{ t }}{% endif %}" target="_blank">/store/{{ m.slug }}</a></div>
        </div>
        <div class="copy">
          <button class="btn out" onclick="copyText('{{ app_base }}/store/{{ m.slug }}')">Copy Store Link</button>
        </div>
      </div>
    {% endif %}

    {% if error %}
      <div class="card err">{{ error }}</div>
    {% endif %}

    <!-- Store profile / appearance -->
    <div class="grid">
      <div class="card">
        <h2>Store Profile</h2>
        <form method="post" action="{{ '/merchant/setup' if setup_mode else ('/merchant/' ~ m.slug ~ '/appearance') }}{% if t %}?t={{ t }}{% endif %}">
          <div class="stack">
            <div>
              <label>Store slug (URL)</label>
              {% if setup_mode %}
                <input type="text" name="slug" placeholder="your-shop" required>
              {% else %}
                <div class="muted">/store/{{ m.slug }}</div>
              {% endif %}
            </div>

            <div>
              <label>Business name</label>
              <input type="text" name="business_name" value="{{ m.business_name if m else '' }}" placeholder="Your shop name">
            </div>

            <div>
              <label>Reply-to email (order notifications)</label>
              <input type="email" name="reply_to_email" value="{{ m.reply_to_email if m else '' }}" placeholder="you@example.com">
            </div>

            <div class="row">
              <div class="col" style="flex:1">
                <label>Logo URL</label>
                <input data-bind="logo_url" id="logo_url" type="text" name="logo_url" value="{{ m.logo_url if m else '' }}" placeholder="https://…">
                <div class="row">
                  <input id="logo_file" type="file" accept="image/*" style="flex:1">
                  <button class="btn out" type="button" onclick="document.getElementById('logo_file').click()">Choose</button>
                  <button class="btn" type="button" onclick="(function(){const fi=document.getElementById('logo_file');fi.onchange=()=>uploadTo('logo_url');fi.click();})()">Upload</button>
                </div>
                <div class="logo" style="margin-top:8px">
                  {% if m and m.logo_url %}<img id="logo_prev" src="{{ m.logo_url }}">{% else %}<span class="muted">Logo preview</span>{% endif %}
                </div>
              </div>

              <div class="col" style="flex:2">
                <label>Banner URL</label>
                <input data-bind="banner_url" id="banner_url" type="text" name="banner_url" value="{{ m.banner_url if m else '' }}" placeholder="https://…">
                <div class="row">
                  <input id="banner_file" type="file" accept="image/*" style="flex:1">
                  <button class="btn out" type="button" onclick="document.getElementById('banner_file').click()">Choose</button>
                  <button class="btn" type="button" onclick="(function(){const fi=document.getElementById('banner_file');fi.onchange=()=>uploadTo('banner_url');fi.click();})()">Upload</button>
                </div>
                <div class="thumb" style="margin-top:8px">
                  {% if m and m.banner_url %}<img id="banner_prev" src="{{ m.banner_url }}">{% else %}<span class="muted">Banner preview</span>{% endif %}
                </div>
              </div>
            </div>

            <div>
              <label>Store description</label>
              <textarea name="description" placeholder="Tell shoppers about your store…">{{ m.description if m else '' }}</textarea>
            </div>

            <div>
              <label>Pi wallet public key (starts with G, 56 chars)</label>
              <input type="text" name="pi_wallet_address" value="{{ m.pi_wallet_address if m else '' }}" placeholder="G…">
            </div>

            <div class="row">
              <div class="col">
                <label>Pi handle (optional)</label>
                <input type="text" name="pi_handle" value="{{ m.pi_handle if m else '' }}" placeholder="@yourhandle">
              </div>
              <div class="col">
                <label>Theme mode (legacy)</label>
                <select name="theme_mode">
                  <option value="dark" {% if m and m.theme_mode=='dark' %}selected{% endif %}>Dark</option>
                  <option value="light" {% if m and m.theme_mode=='light' %}selected{% endif %}>Light</option>
                </select>
              </div>
            </div>

            <div class="stack">
              <label>Select a layout theme</label>
              <input type="hidden" id="theme" name="theme" value="{{ m.theme if m else 'theme-a' }}">
              <div class="themes">
                {% set chosen = m.theme if m else 'theme-a' %}
                {% for code, title in [('theme-a','Grid basic'),('theme-b','Cards w/ badge'),('theme-c','Masonry'),('theme-d','Compact rows')] %}
                  <div class="themeOpt {% if chosen==code %}sel{% endif %}" data-v="{{ code }}" onclick="pickTheme('{{ code }}')">
                    <div class="muted">{{ title }}</div>
                    <div style="margin-top:6px;border:1px dashed var(--line);border-radius:8px;height:64px;display:flex;align-items:center;justify-content:center;color:var(--muted)">Preview {{ code[-1:]|upper }}</div>
                  </div>
                {% endfor %}
              </div>
            </div>

            <div class="stack">
              <label>Colorway</label>
              <input type="hidden" id="colorway" name="colorway" value="{{ m.colorway if m else 'blue' }}">
              <div class="cways">
                {% set cw = m.colorway if m else 'blue' %}
                {% for code,color in [('blue','#2b5cff'),('purple','#6f42c1'),('teal','#1abc9c'),('rose','#e91e63'),('amber','#ffb300')] %}
                  <span class="swatch {% if cw==code %}sel{% endif %}" data-v="{{ code }}" title="{{ code }}" style="background:{{ color }}" onclick="pickColor('{{ code }}')"></span>
                {% endfor %}
              </div>
            </div>

            <div class="stack">
              <label>Font</label>
              <input type="hidden" id="font_family" name="font_family" value="{{ m.font_family if m else 'system-ui' }}">
              <input type="hidden" id="font_url" name="font_url" value="{{ m.font_url if m else '' }}">
              {% set ff = m.font_family if m else 'system-ui' %}
              <div class="fonts">
                <div class="fopt {% if ff=='system-ui' %}sel{% endif %}" data-v="system-ui" onclick="pickFont('system-ui','')">System (Default)</div>
                <div class="fopt {% if ff=='Inter' %}sel{% endif %}" data-v="Inter" onclick="pickFont('Inter','https://fonts.googleapis.com/css2?family=Inter:wght@400;700;800&display=swap')">Inter</div>
                <div class="fopt {% if ff=='Poppins' %}sel{% endif %}" data-v="Poppins" onclick="pickFont('Poppins','https://fonts.googleapis.com/css2?family=Poppins:wght@400;700;800&display=swap')">Poppins</div>
              </div>
              <div class="note">Fonts will apply on your customer store automatically.</div>
            </div>

            <div class="row" style="justify-content:flex-end">
              <button class="btn" type="submit">{{ 'Create store' if setup_mode else 'Save changes' }}</button>
            </div>
          </div>
        </form>
      </div>

      <!-- Live preview -->
      <div class="card">
        <h2>Live Preview</h2>
        <div class="stack">
          <div class="logo"><img id="lp_logo" src="{{ m.logo_url if m else '' }}" onerror="this.src='';this.parentNode.innerHTML='<span class=&quot;muted&quot;>Logo preview</span>';"></div>
          <div class="thumb"><img id="lp_banner" src="{{ m.banner_url if m else '' }}" onerror="this.src='';this.parentNode.innerHTML='<span class=&quot;muted&quot;>Banner preview</span>';"></div>
          <div class="muted">This preview updates when you paste or upload new images.</div>
        </div>
      </div>
    </div>

    {% if not setup_mode %}
      <!-- QUICK LINKS -->
      <div class="card">
        <div class="row" style="justify-content:space-between;align-items:center">
          <div>
            <strong>Customer-facing store link</strong><br>
            <a href="/store/{{ m.slug }}{% if t %}?t={{ t }}{% endif %}" target="_blank">{{ app_base }}/store/{{ m.slug }}</a>
          </div>
          <button class="btn out" onclick="copyText('{{ app_base }}/store/{{ m.slug }}')">Copy</button>
        </div>
      </div>

      <!-- Add product -->
      <div class="card">
        <h2>Add a Product</h2>
        <form method="post" action="/merchant/{{ m.slug }}/items/new{% if t %}?t={{ t }}{% endif %}">
          <div class="grid">
            <div class="stack">
              <label>Title</label>
              <input type="text" name="title" placeholder="Product title" required>
              <label>SKU (optional)</label>
              <input type="text" name="sku" placeholder="SKU-123">
              <label>Image URL</label>
              <input data-bind="image_url_new" id="image_url_new" type="text" name="image_url" placeholder="https://…">
              <div class="row">
                <input id="img_file_new" type="file" accept="image/*" style="flex:1">
                <button class="btn out" type="button" onclick="document.getElementById('img_file_new').click()">Choose</button>
                <button class="btn" type="button" onclick="(function(){const fi=document.getElementById('img_file_new');fi.onchange=()=>uploadTo('image_url_new');fi.click();})()">Upload</button>
              </div>
            </div>

            <div class="stack">
              <label>Description</label>
              <textarea name="description" placeholder="Describe the item…"></textarea>
              <div class="row">
                <div class="col">
                  <label>Price (Pi)</label>
                  <input type="number" name="pi_price" step="0.0000001" min="0" required>
                </div>
                <div class="col">
                  <label>Stock qty</label>
                  <input type="number" name="stock_qty" step="1" min="0" value="10">
                </div>
              </div>
              <div class="row">
                <label style="display:flex;align-items:center;gap:8px">
                  <input type="checkbox" name="allow_backorder"> Allow backorder
                </label>
              </div>
              <div class="row" style="justify-content:flex-end">
                <button class="btn" type="submit">Add product</button>
              </div>
            </div>
          </div>
        </form>
      </div>

      <!-- Items list -->
      <div class="items">
        {% for it in items %}
          <div class="item">
            <div class="itthumb">
              {% if it.image_url %}
                <img src="{{ it.image_url }}" alt="{{ it.title }}">
              {% else %}
                <span class="muted">No image</span>
              {% endif %}
            </div>
            <div style="font-weight:800">{{ it.title }}</div>
            {% if it.description %}<div class="muted" style="margin:6px 0">{{ it.description }}</div>{% endif %}
            <div class="rowsp">
              <div class="muted">{{ '%.7f'|format(it.pi_price) }} Pi • Stock {{ it.stock_qty }}</div>
              <a class="btn out" href="/checkout/{{ it.link_id }}{% if t %}?t={{ t }}{% endif %}" target="_blank">Buy Now link</a>
            </div>

            <!-- Edit form -->
            <details style="margin-top:8px">
              <summary class="muted">Edit</summary>
              <form method="post" action="/merchant/{{ m.slug }}/items/{{ it.id }}/edit{% if t %}?t={{ t }}{% endif %}" class="stack" style="margin-top:8px">
                <div class="grid">
                  <div class="stack">
                    <label>Title</label>
                    <input type="text" name="title" value="{{ it.title }}">
                    <label>SKU</label>
                    <input type="text" name="sku" value="{{ it.sku or '' }}">
                    <label>Image URL</label>
                    <input data-bind="image_url_{{ it.id }}" id="image_url_{{ it.id }}" type="text" name="image_url" value="{{ it.image_url or '' }}">
                    <div class="row">
                      <input id="img_file_{{ it.id }}" type="file" accept="image/*" style="flex:1">
                      <button class="btn out" type="button" onclick="document.getElementById('img_file_{{ it.id }}').click()">Choose</button>
                      <button class="btn" type="button" onclick="(function(){const fi=document.getElementById('img_file_{{ it.id }}');fi.onchange=()=>uploadTo('image_url_{{ it.id }}');fi.click();})()">Upload</button>
                    </div>
                  </div>
                  <div class="stack">
                    <label>Description</label>
                    <textarea name="description">{{ it.description or '' }}</textarea>
                    <div class="row">
                      <div class="col">
                        <label>Price (Pi)</label>
                        <input type="number" name="pi_price" step="0.0000001" min="0" value="{{ '%.7f'|format(it.pi_price) }}">
                      </div>
                      <div class="col">
                        <label>Stock qty</label>
                        <input type="number" name="stock_qty" step="1" min="0" value="{{ it.stock_qty }}">
                      </div>
                    </div>
                    <div class="row">
                      <label style="display:flex;align-items:center;gap:8px">
                        <input type="checkbox" name="allow_backorder" {% if it.allow_backorder %}checked{% endif %}> Allow backorder
                      </label>
                      <label style="display:flex;align-items:center;gap:8px">
                        <input type="checkbox" name="active" {% if it.active %}checked{% endif %}> Active
                      </label>
                    </div>
                    <div class="row" style="justify-content:flex-end;gap:8px">
                      <button class="btn" type="submit">Save</button>
                      <form method="post" action="/merchant/{{ m.slug }}/items/{{ it.id }}/delete{% if t %}?t={{ t }}{% endif %}">
                        <button class="btn danger" type="submit" onclick="return confirm('Delete this item?')">Delete</button>
                      </form>
                    </div>
                  </div>
                </div>
              </form>
            </details>
          </div>
        {% endfor %}
      </div>
    {% endif %}
  </div>

  <script>
    // live text previews for logo/banner on change
    document.querySelector('[data-bind="logo_url"]')?.addEventListener('input', e=>{
      const v = e.target.value.trim(); const img = document.getElementById('lp_logo');
      if(img){ img.src=v; img.onerror=()=>{img.removeAttribute('src');}; }
    });
    document.querySelector('[data-bind="banner_url"]')?.addEventListener('input', e=>{
      const v = e.target.value.trim(); const img = document.getElementById('lp_banner');
      if(img){ img.src=v; img.onerror=()=>{img.removeAttribute('src');}; }
    });
  </script>
</body>
</html>
