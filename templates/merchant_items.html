<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>{% if setup_mode %}Create your IZZA PAY Store{% else %}Merchant Items{% endif %}</title>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
  <link rel="stylesheet" href="/static/themes.css">
  <style>
    html,body{max-width:100%;overflow-x:hidden;}
    body{font-family:Arial,Helvetica,sans-serif;margin:0}

    .wrap{max-width:960px;margin:0 auto;padding:16px}
    @media (min-width:640px){ .wrap{padding:24px} }

    .topbar{
      display:flex;align-items:center;justify-content:space-between;gap:8px;flex-wrap:wrap;
      padding:8px 0; position:sticky; top:0; z-index:10;
      background:rgba(11,15,23,.9); backdrop-filter:blur(8px); border-bottom:1px solid var(--line);
    }
    .brand{display:flex;align-items:center;gap:10px;min-width:0}
    .brand img{height:24px}
    .actions{display:flex;gap:8px;flex-wrap:wrap}
    .actions a{white-space:nowrap}

    .grid{display:grid; gap:12px; grid-template-columns: 1fr;}
    @media (min-width:900px){ .grid{ grid-template-columns: 380px 1fr; align-items:start; } }

    .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:14px}
    .h1{font-size:24px;font-weight:800;margin:2px 0 10px}
    .h2{font-size:18px;font-weight:800;margin:0 0 10px}
    .muted{color:var(--muted)}

    .row{display:flex;gap:10px;flex-wrap:wrap}
    .stack{display:flex;flex-direction:column;gap:8px}

    .field{display:flex;flex-direction:column;gap:6px}
    .field-inline{display:grid;gap:10px;grid-template-columns:1fr}
    @media (min-width:600px){ .field-inline{grid-template-columns:1fr 1fr} }
    .ip-input,.ip-select,.ip-textarea{width:100%}

    .pickers{ display:grid; gap:12px; grid-template-columns:1fr; }
    @media (min-width:700px){ .pickers{ grid-template-columns:1fr 1fr; } }
    .picker .thumb{
      width:100%; height:120px; border:1px solid var(--line); border-radius:10px;
      background:#fff; display:flex; align-items:center; justify-content:center; overflow:hidden;
    }
    .picker .thumb img{ width:100%; height:100%; object-fit:cover }

    .itimg{ width:80px;height:80px;border:1px solid var(--line);border-radius:10px;background:#fff;overflow:hidden;display:flex;align-items:center;justify-content:center }
    .itimg img{width:100%;height:100%;object-fit:cover}

    /* Responsive table */
    .table-wrap{width:100%; overflow-x:auto}
    table{width:100%;border-collapse:collapse; min-width:780px}
    th,td{padding:8px;border-bottom:1px solid var(--line);text-align:left;vertical-align:middle}
    th{color:var(--muted);font-weight:600}

    .theme-swatches{display:flex;gap:10px;flex-wrap:wrap}
    .swatch{
      width:120px; padding:8px; border:1px solid var(--line); border-radius:10px; cursor:pointer;
      display:flex; flex-direction:column; gap:6px; align-items:center; background:var(--card)
    }
    .swatch .preview{ width:100%; height:60px; border-radius:8px; border:1px solid var(--line); }
    .swatch small{color:var(--muted)}
    .swatch.selected{outline:2px solid var(--accent);}

    .link-chip{
      display:inline-flex; align-items:center; gap:8px; flex-wrap:wrap;
      padding:8px; border:1px solid var(--line); border-radius:10px; background:var(--card)
    }
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;}
    .btn-row{display:flex; gap:8px; flex-wrap:wrap}
    .tiny{font-size:.9rem; padding:8px 10px}

    /* inline product editor row */
    .edit-row{background:rgba(255,255,255,.02)}
    .sep{height:1px;background:var(--line);margin:10px 0}

    /* keep edit/delete controls visible without horizontal scroll */
    .actions-col{min-width:180px}
    .danger{background:#7a2c2c;color:#fff}
    .ghost-danger{border:1px solid #7a2c2c;color:#fff;background:transparent}
  </style>
</head>
{% set cw = colorway or (m.colorway if m) or 'cw-blue' %}
<body class="{{ cw }} theme-a">
  <div class="wrap">

    <div class="topbar">
      <div class="brand">
        <img src="/static/izzapay-mark.svg" alt="IZZA mark">
        <img src="/static/izzapay-word.svg" alt="IZZA PAY">
      </div>
      <div class="actions">
        <a class="ip-btn ghost" href="/explore">View Stores</a>
      </div>
    </div>

    {% if setup_mode %}
      <div class="h1">Create your IZZA PAY Store</div>
      {% if username %}
        <p class="muted" style="margin-top:-6px">Signed in as <strong>@{{ username }}</strong></p>
      {% endif %}

      {% if error %}
        <div class="card" style="border-color:#7a2c2c;background:rgba(122,44,44,.15);margin-bottom:10px">
          <div>{{ error }}</div>
        </div>
      {% endif %}

      <!-- carry token -->
      <form class="grid" method="post" action="/merchant/setup">
        <input type="hidden" name="t" value="{{ t or '' }}">
        <input type="hidden" name="colorway" id="colorway" value="{{ cw }}">

        <div class="card stack">
          <div class="field">
            <label class="ip-label">Store name</label>
            <input class="ip-input" name="business_name" placeholder="Your store name">
          </div>

          <div class="field">
            <label class="ip-label">Store slug (optional)</label>
            <input class="ip-input" name="slug" placeholder="your-handle">
            <small class="muted">Your storefront URL will be <code>/store/&lt;slug&gt;</code>.</small>
          </div>

          <div class="field">
            <label class="ip-label">Order notifications email</label>
            <input class="ip-input" name="reply_to_email" placeholder="you@example.com">
          </div>

          <div class="field">
            <label class="ip-label">Pi wallet public key</label>
            <input class="ip-input" name="pi_wallet_address" placeholder="G… (56 characters)">
          </div>

          <div class="field">
            <label class="ip-label">Pi handle (optional)</label>
            <input class="ip-input" name="pi_handle" placeholder="@your-pi-handle">
          </div>

          <div class="field">
            <label class="ip-label">Theme mode</label>
            <select class="ip-select" name="theme_mode">
              <option value="dark" selected>Dark</option>
              <option value="light">Light</option>
            </select>
          </div>

          <div class="field">
            <label class="ip-label">Images</label>
            <div class="pickers">
              <div class="picker card">
                <div class="muted" style="font-weight:600;margin-bottom:6px">Logo</div>
                <div class="thumb" id="logoThumb"><span class="muted">Preview</span></div>
                <div class="row">
                  <input type="file" id="logoFile" accept="image/*" style="flex:1" />
                  <button class="ip-btn" type="button" id="logoUploadBtn">Upload</button>
                </div>
                <div class="field" style="margin-top:6px">
                  <input class="ip-input" id="logoUrl" name="logo_url" placeholder="https://… (or paste a logo URL)">
                </div>
              </div>

              <div class="picker card">
                <div class="muted" style="font-weight:600;margin-bottom:6px">Banner (optional)</div>
                <div class="thumb" id="bannerThumb"><span class="muted">Preview</span></div>
                <div class="row">
                  <input type="file" id="bannerFile" accept="image/*" style="flex:1" />
                  <button class="ip-btn" type="button" id="bannerUploadBtn">Upload</button>
                </div>
                <div class="field" style="margin-top:6px">
                  <input class="ip-input" id="bannerUrl" name="banner_url" placeholder="https://… (or paste a banner URL)">
                </div>
              </div>
            </div>
          </div>

          <div class="row" style="justify-content:flex-end;margin-top:4px">
            <button class="ip-btn" type="submit">Save &amp; Continue</button>
          </div>
        </div>

        <div class="card stack">
          <div class="muted" style="font-weight:600">Look &amp; Feel</div>
          <div class="theme-swatches">
            <div class="swatch" data-cw="cw-blue">
              <div class="preview theme-preview cw-blue theme-a">
                <div class="blk"></div><div class="blk"></div><div class="blk"></div>
              </div><small>Blue</small>
            </div>
            <div class="swatch" data-cw="cw-mint">
              <div class="preview theme-preview cw-mint theme-a">
                <div class="blk"></div><div class="blk"></div><div class="blk"></div>
              </div><small>Mint</small>
            </div>
            <div class="swatch" data-cw="cw-purple">
              <div class="preview theme-preview cw-purple theme-a">
                <div class="blk"></div><div class="blk"></div><div class="blk"></div>
              </div><small>Purple</small>
            </div>
            <div class="swatch" data-cw="cw-amber">
              <div class="preview theme-preview cw-amber theme-a">
                <div class="blk"></div><div class="blk"></div><div class="blk"></div>
              </div><small>Amber</small>
            </div>
          </div>
          <p class="muted" style="margin-top:8px">
            Tap a color to preview instantly. We’ll save this choice with your store.
          </p>
        </div>
      </form>

    {% else %}
      <div class="h1">{{ m.business_name }}</div>

      <!-- EDIT STORE SETTINGS (incl. colorway) -->
      <div class="card" style="margin-bottom:12px">
        <div class="h2">Store Settings</div>
        <form class="stack" method="post" action="/merchant/{{ m.slug }}/update{% if t %}?t={{ t }}{% endif %}">
          <input type="hidden" name="t" value="{{ t or '' }}">
          <input type="hidden" name="colorway" id="edit-colorway" value="{{ cw }}">
          <div class="field-inline">
            <div class="field">
              <label class="ip-label">Store name</label>
              <input class="ip-input" name="business_name" value="{{ m.business_name or '' }}">
            </div>
            <div class="field">
              <label class="ip-label">Order notifications email</label>
              <input class="ip-input" name="reply_to_email" value="{{ m.reply_to_email or '' }}">
            </div>
          </div>

          <div class="field-inline">
            <div class="field">
              <label class="ip-label">Pi wallet public key</label>
              <input class="ip-input" name="pi_wallet_address" value="{{ m.pi_wallet_address or '' }}">
            </div>
            <div class="field">
              <label class="ip-label">Pi handle</label>
              <input class="ip-input" name="pi_handle" value="{{ m.pi_handle or '' }}">
            </div>
          </div>

          <div class="field-inline">
            <div class="field">
              <label class="ip-label">Logo URL</label>
              <input class="ip-input" name="logo_url" value="{{ m.logo_url or '' }}">
            </div>
            <div class="field">
              <label class="ip-label">Theme mode</label>
              <select class="ip-select" name="theme_mode">
                <option value="dark" {% if m.theme_mode=='dark' %}selected{% endif %}>Dark</option>
                <option value="light" {% if m.theme_mode=='light' %}selected{% endif %}>Light</option>
              </select>
            </div>
          </div>

          <div class="sep"></div>
          <div class="muted" style="font-weight:600">Colorway</div>
          <div class="theme-swatches" id="edit-swatches">
            {% set choices = ['cw-blue','cw-mint','cw-purple','cw-amber'] %}
            {% for c in choices %}
              <div class="swatch {% if cw==c %}selected{% endif %}" data-cw="{{ c }}">
                <div class="preview theme-preview {{ c }} theme-a">
                  <div class="blk"></div><div class="blk"></div><div class="blk"></div>
                </div><small>{{ c.split('-')[1] | capitalize }}</small>
              </div>
            {% endfor %}
          </div>

          <div class="row" style="justify-content:flex-end;margin-top:4px">
            <button class="ip-btn" type="submit">Save Changes</button>
          </div>
        </form>
      </div>

      <!-- STOREFRONT LINK -->
      <div class="card" style="margin-bottom:12px">
        <div class="h2">Your Storefront</div>
        <div class="row" style="align-items:center;gap:10px">
          <div class="link-chip">
            <span class="muted">URL</span>
            <span class="mono" id="storeUrl">{{ APP_BASE_URL }}/store/{{ m.slug }}</span>
          </div>
          <div class="btn-row">
            <a class="ip-btn tiny" target="_blank" href="/store/{{ m.slug }}">Open</a>
            <button class="ip-btn ghost tiny" type="button" data-copy="#storeUrl">Copy</button>
          </div>
        </div>
      </div>

      <!-- CREATE PRODUCT -->
      <div class="card" id="create-product">
        <div class="h2">Create Product</div>
        <form class="stack" method="post" action="/merchant/{{ m.slug }}/items/new{% if t %}?t={{ t }}{% endif %}">
          <!-- also carry token in body -->
          <input type="hidden" name="t" value="{{ t or '' }}">
          <div class="field-inline">
            <div class="field">
              <label class="ip-label">Title</label>
              <input class="ip-input" name="title" required>
            </div>
            <div class="field">
              <label class="ip-label">SKU</label>
              <input class="ip-input" name="sku">
            </div>
          </div>

          <div class="field">
            <label class="ip-label">Image</label>
            <div class="row" style="gap:8px;align-items:center">
              <div class="itimg" id="itThumb"><span class="muted" style="font-size:12px">Preview</span></div>
              <input type="file" id="itFile" accept="image/*" />
              <button type="button" class="ip-btn" id="itUploadBtn">Upload</button>
            </div>
            <input class="ip-input" id="itUrl" name="image_url" placeholder="https://… (or paste an image URL)">
          </div>

          <div class="field-inline">
            <div class="field">
              <label class="ip-label">Price (Pi)</label>
              <input class="ip-input" name="pi_price" inputmode="decimal" placeholder="0.1" required>
            </div>
            <div class="field">
              <label class="ip-label">Stock Qty</label>
              <input class="ip-input" name="stock_qty" inputmode="numeric" placeholder="10">
            </div>
          </div>

          <label class="ip-label" style="display:flex;gap:6px;align-items:center">
            <input type="checkbox" name="allow_backorder" value="1"> Allow backorder
          </label>

          <div class="row" style="justify-content:flex-end">
            <button class="ip-btn" type="submit" id="addItemBtn">Add Item</button>
          </div>
        </form>
      </div>

      <!-- LIST -->
      <div class="card" style="margin-top:12px;">
        <div class="h2">Products</div>
        <div class="table-wrap">
          <table>
            <thead>
              <tr><th>Image</th><th>Title</th><th>Price (Pi)</th><th>Stock</th><th>Buy Now Link</th><th class="actions-col">Actions</th></tr>
            </thead>
            <tbody>
            {% for it in items %}
              <tr>
                <td>
                  <div class="itimg">
                    {% if it.image_url %}
                      <img src="/uimg?src={{ it.image_url | urlencode }}" alt="">
                    {% else %}
                      <span class="muted" style="font-size:12px">—</span>
                    {% endif %}
                  </div>
                </td>
                <td>{{ it.title }}</td>
                <td>{{ '%.7f'|format(it.pi_price) }}</td>
                <td>{{ it.stock_qty }}</td>
                <td>
                  <div class="row" style="align-items:center;gap:8px">
                    <div class="link-chip">
                      <span class="mono" id="lnk-{{ it.link_id }}">{{ APP_BASE_URL }}/checkout/{{ it.link_id }}</span>
                    </div>
                    <div class="btn-row">
                      <a class="ip-btn tiny" target="_blank" href="/checkout/{{ it.link_id }}">Open</a>
                      <button class="ip-btn ghost tiny" type="button" data-copy="#lnk-{{ it.link_id }}">Copy</button>
                    </div>
                  </div>
                </td>
                <td class="actions-col">
                  <div class="btn-row" style="flex-direction:column;align-items:stretch">
                    <button class="ip-btn tiny" type="button" data-edit-toggle="{{ it.id }}">Edit</button>
                    <form method="post" action="/merchant/{{ m.slug }}/items/delete{% if t %}?t={{ t }}{% endif %}" onsubmit="return confirm('Delete this product? This cannot be undone.');">
                      <input type="hidden" name="item_id" value="{{ it.id }}">
                      <input type="hidden" name="t" value="{{ t or '' }}">
                      <button class="ip-btn tiny danger" type="submit">Delete</button>
                    </form>
                  </div>
                </td>
              </tr>
              <!-- inline editor row -->
              <tr class="edit-row" id="edit-row-{{ it.id }}" style="display:none">
                <td colspan="6">
                  <form class="stack" method="post" action="/merchant/{{ m.slug }}/items/update{% if t %}?t={{ t }}{% endif %}">
                    <input type="hidden" name="t" value="{{ t or '' }}">
                    <input type="hidden" name="item_id" value="{{ it.id }}">
                    <div class="field-inline">
                      <div class="field">
                        <label class="ip-label">Title</label>
                        <input class="ip-input" name="title" value="{{ it.title }}">
                      </div>
                      <div class="field">
                        <label class="ip-label">SKU</label>
                        <input class="ip-input" name="sku" value="{{ it.sku }}">
                      </div>
                    </div>
                    <div class="field-inline">
                      <div class="field">
                        <label class="ip-label">Price (Pi)</label>
                        <input class="ip-input" name="pi_price" inputmode="decimal" value="{{ '%.7f'|format(it.pi_price) }}">
                      </div>
                      <div class="field">
                        <label class="ip-label">Stock Qty</label>
                        <input class="ip-input" name="stock_qty" inputmode="numeric" value="{{ it.stock_qty }}">
                      </div>
                    </div>
                    <div class="field">
                      <label class="ip-label">Image URL</label>
                      <input class="ip-input" name="image_url" value="{{ it.image_url or '' }}">
                    </div>
                    <div class="row" style="justify-content:flex-end">
                      <button class="ip-btn ghost tiny" type="button" data-edit-toggle="{{ it.id }}">Cancel</button>
                      <button class="ip-btn tiny" type="submit">Save</button>
                    </div>
                  </form>
                </td>
              </tr>
            {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    {% endif %}
  </div>

  <script>
  function setThumb(id, url){
    const el = document.getElementById(id);
    if(!el) return; el.innerHTML = '';
    const img = document.createElement('img'); img.src = url; el.appendChild(img);
  }
  async function uploadTo(path, file){
    const fd = new FormData(); fd.append('file', file);
    const r = await fetch('/upload', {method:'POST', body:fd});
    if(!r.ok) throw new Error('upload failed'); const j = await r.json();
    if(!j.ok || !j.url) throw new Error('bad response'); return j.url;
  }

  // Copy helpers (storefront + per-item)
  function copyFromSelector(sel){
    const el = document.querySelector(sel);
    if(!el) return;
    const text = el.textContent.trim();
    if(!navigator.clipboard){
      const ta = document.createElement('textarea');
      ta.value = text; document.body.appendChild(ta); ta.select();
      try{ document.execCommand('copy'); }catch(e){}
      document.body.removeChild(ta);
      return;
    }
    navigator.clipboard.writeText(text);
  }
  document.addEventListener('click', (e)=>{
    const t = e.target;
    if(t && t.matches('[data-copy]')){
      const sel = t.getAttribute('data-copy');
      if(sel){ copyFromSelector(sel); t.textContent='Copied'; setTimeout(()=>t.textContent='Copy', 1200); }
    }
  });

  // Logo upload + preview
  (function(){
    const file = document.getElementById('logoFile');
    const btn  = document.getElementById('logoUploadBtn');
    const inp  = document.getElementById('logoUrl');
    if(!file || !btn || !inp) return;
    btn.addEventListener('click', async () => {
      if(!file.files || !file.files[0]){ inp.focus(); return; }
      btn.disabled = true; btn.textContent = 'Uploading…';
      try{ const url = await uploadTo('/upload', file.files[0]); inp.value = url; setThumb('logoThumb', url); }
      catch(e){ alert('Upload failed. You can paste a URL instead.'); }
      finally{ btn.disabled = false; btn.textContent = 'Upload'; }
    });
    inp.addEventListener('input', () => { const v = inp.value.trim(); if(v) setThumb('logoThumb', v); });
  })();

  // Banner upload + preview
  (function(){
    const file = document.getElementById('bannerFile');
    const btn  = document.getElementById('bannerUploadBtn');
    const inp  = document.getElementById('bannerUrl');
    if(!file || !btn || !inp) return;
    btn.addEventListener('click', async () => {
      if(!file.files || !file.files[0]){ inp.focus(); return; }
      btn.disabled = true; btn.textContent = 'Uploading…';
      try{ const url = await uploadTo('/upload', file.files[0]); inp.value = url; setThumb('bannerThumb', url); }
      catch(e){ alert('Upload failed. You can paste a URL instead.'); }
      finally{ btn.disabled = false; btn.textContent = 'Upload'; }
    });
    inp.addEventListener('input', () => { const v = inp.value.trim(); if(v) setThumb('bannerThumb', v); });
  })();

  // Item upload + preview
  (function(){
    const file = document.getElementById('itFile');
    const btn  = document.getElementById('itUploadBtn');
    const inp  = document.getElementById('itUrl');
    if(!file || !btn || !inp) return;
    btn.addEventListener('click', async () => {
      if(!file.files || !file.files[0]){ inp.focus(); return; }
      btn.disabled = true; btn.textContent = 'Uploading…';
      try{ const url = await uploadTo('/upload', file.files[0]); inp.value = url; setThumb('itThumb', url); }
      catch(e){ alert('Upload failed. You can paste an image URL instead.'); }
      finally{ btn.disabled = false; btn.textContent = 'Upload'; }
    });
    inp.addEventListener('input', () => { const v = inp.value.trim(); if(v) setThumb('itThumb', v); });
  })();

  // Colorway picker (setup page) — live preview + hidden field
  (function(){
    const swatches = document.querySelectorAll('.swatch');
    const hidden = document.getElementById('colorway');
    const body = document.body;
    // mark selected on load (for setup)
    swatches.forEach(sw => {
      if(hidden && sw.getAttribute('data-cw') === hidden.value){ sw.classList.add('selected'); }
    });
    swatches.forEach(sw => {
      sw.addEventListener('click', () => {
        body.classList.remove('cw-blue','cw-mint','cw-purple','cw-amber');
        swatches.forEach(s=>s.classList.remove('selected'));
        const cw = sw.getAttribute('data-cw'); if(cw) {
          body.classList.add(cw);
          if(hidden) hidden.value = cw;
          sw.classList.add('selected');
        }
      });
    });
  })();

  // Colorway picker (edit store section)
  (function(){
    const wrap = document.getElementById('edit-swatches');
    if(!wrap) return;
    const hidden = document.getElementById('edit-colorway');
    const body = document.body;
    const swatches = wrap.querySelectorAll('.swatch');
    swatches.forEach(sw=>{
      sw.addEventListener('click', ()=>{
        body.classList.remove('cw-blue','cw-mint','cw-purple','cw-amber');
        swatches.forEach(s=>s.classList.remove('selected'));
        const cw = sw.getAttribute('data-cw');
        if(cw){ body.classList.add(cw); hidden.value = cw; sw.classList.add('selected'); }
      });
    });
  })();

  // Guard: simple client validation for price before "Add Item"
  (function(){
    const form = document.querySelector('#create-product form');
    if(!form) return;
    form.addEventListener('submit', (e) => {
      const priceEl = form.querySelector('input[name="pi_price"]');
      const titleEl = form.querySelector('input[name="title"]');
      const v = (priceEl?.value || '').trim();
      const price = Number(v);
      if(!titleEl?.value.trim()){
        e.preventDefault(); alert('Please add a product title.'); titleEl?.focus(); return false;
      }
      if(!v || isNaN(price) || price <= 0){
        e.preventDefault(); alert('Enter a valid Pi price (e.g., 0.1)'); priceEl?.focus(); return false;
      }
      return true;
    });
  })();

  // Toggle inline product editor
  document.addEventListener('click', (e)=>{
    const btn = e.target.closest('[data-edit-toggle]');
    if(!btn) return;
    const id = btn.getAttribute('data-edit-toggle');
    const row = document.getElementById('edit-row-' + id);
    if(!row) return;
    row.style.display = (row.style.display === 'none' || !row.style.display) ? 'table-row' : 'none';
  });
  </script>
</body>
</html>
