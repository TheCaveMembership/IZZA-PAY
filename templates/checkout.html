<!-- checkout.html -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Checkout</title>
  <script src="https://sdk.minepi.com/pi-sdk.js"></script>
</head>
<body>
  <h1>Checkout</h1>

  <form id="checkout-form">
    <label for="email">Email (required for receipts & tracking):</label>
    <input type="email" id="email" name="email" required>
    <br><br>

    <label for="address">Shipping Address:</label>
    <textarea id="address" name="address"></textarea>
    <br><br>

    <button type="button" id="pay-with-pi">Pay with Pi</button>
  </form>

  <script>
    document.getElementById("pay-with-pi").addEventListener("click", async () => {
      const email = document.getElementById("email").value;
      if (!email) {
        alert("Email is required for order confirmation and receipts.");
        return;
      }

      const address = document.getElementById("address").value;

      try {
        const paymentData = {
          amount: window.localStorage.getItem("cart_total"),
          memo: "Purchase from IzzaPay",
          metadata: {
            email: email,
            address: address,
            cart: JSON.parse(window.localStorage.getItem("cart") || "[]")
          }
        };

        const payment = await Pi.createPayment(paymentData, {
          onReadyForServerApproval: async (paymentId) => {
            await fetch("/approve_payment", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ paymentId })
            });
          },
          onReadyForServerCompletion: async (paymentId, txid) => {
            await fetch("/complete_payment", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ paymentId, txid })
            });
          },
          onCancel: (paymentId) => {
            console.log("Payment cancelled:", paymentId);
          },
          onError: (error, paymentId) => {
            console.error("Payment error:", error, paymentId);
          }
        });

      } catch (err) {
        console.error("Payment initiation failed:", err);
        alert("Could not start payment. Please try again.");
      }
    });
  </script>
</body>
</html>
