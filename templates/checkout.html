<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Checkout — {{ i.title if i else 'Cart' }}</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    :root{--bg:#0b0f17;--card:#0f1728;--line:#1f2a44;--txt:#e8f0ff;--muted:#bcd0ff;--brand:#6e9fff}
    body{font-family:Arial,Helvetica,sans-serif;background:var(--bg);color:var(--txt);margin:0}
    .wrap{max-width:620px;margin:0 auto;padding:20px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:16px;margin-bottom:16px}
    .row{display:flex;gap:12px;align-items:center}
    .muted{color:var(--muted)}
    .btn{background:var(--brand);color:#0b0f17;border:0;border-radius:10px;padding:12px 14px;font-weight:800;cursor:pointer;text-decoration:none;display:inline-block}
  </style>
  <script src="https://sdk.minepi.com/pi-sdk.js"></script>
</head>
<body>
<div class="wrap">
  {% if sold_out %}
    <div class="card">
      <h2>Sold out</h2>
      <p class="muted">This item is not available.</p>
    </div>
  {% else %}
    <div class="card">
      <div class="row">
        {% if i and i.logo_url %}<img src="{{ i.logo_url }}" alt="" style="height:36px;border-radius:6px;border:1px solid var(--line)">{% endif %}
        <div>
          <div style="font-weight:800">{{ i.business_name if i else 'Cart' }}</div>
          <div class="muted">{{ i.title if i else 'Cart total' }}</div>
        </div>
      </div>

      <div style="margin-top:12px">
        <div>Quantity: <strong>{{ qty }}</strong></div>
        <div>Total: <strong>{{ '%.7f'|format(expected_pi) }} Pi</strong></div>
      </div>

      <div style="margin-top:16px">
        <button id="payBtn" class="btn">Pay with Pi</button>
        <p id="msg" class="muted" style="margin-top:10px;"></p>
      </div>
    </div>
  {% endif %}
</div>

<script>
(function(){
  const sessionId = "{{ session_id|e }}";
  const amount = {{ expected_pi if expected_pi else 0 }};
  const cartMode = {{ 'true' if cart_mode else 'false' }};
  const sandbox = {{ 'true' if PI_SANDBOX else 'false' }};
  const appId = "{{ PI_APP_ID }}";
  const redirectSlug = "{{ slug if slug else '' }}"; // provided by server

  const btn = document.getElementById('payBtn');
  const msg = document.getElementById('msg');

  function setMsg(t){ if(msg){ msg.textContent = t || ''; } }

  function initPi(){
    try{
      if (!window.Pi || !Pi.init) return false;
      Pi.init({ version: "2.0", sandbox: sandbox, appId: appId });
      return true;
    }catch(e){ return false; }
  }

  function ensureAuth(){
    const scopes = ['payments','username'];
    function onIncompletePaymentFound(payment){ /* optional */ }
    return Pi.authenticate(scopes, onIncompletePaymentFound);
  }

  initPi();

  btn?.addEventListener('click', function(){
    setMsg('Opening Pi payment…');

    if (!window.Pi || !Pi.createPayment){
      setMsg("Open this page in Pi Browser.");
      return;
    }

    ensureAuth().then(() => {
      const paymentData = {
        amount: amount,
        memo: cartMode ? ("Cart order " + sessionId) : ("Order " + sessionId),
        metadata: { session_id: sessionId }
      };

      Pi.createPayment(paymentData, {
        onReadyForServerApproval: function(paymentId){
          fetch('/api/pi/approve', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ paymentId, session_id: sessionId })
          });
        },
        onReadyForServerCompletion: function(paymentId, txid){
          fetch('/api/pi/complete', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ paymentId, session_id: sessionId, txid })
          })
          .then(r => r.json())
          .then(res => {
            // Always send buyer back to the storefront with success flag
            const fallback = redirectSlug ? `/store/${redirectSlug}?success=1` : '/success';
            const target = (res && (res.redirect_url || res.buyer_status_url)) || fallback;
            window.location.href = target;
          })
          .catch(() => {
            const fallback = redirectSlug ? `/store/${redirectSlug}?success=1` : '/success';
            window.location.href = fallback;
          });
        },
        onCancel: function(){ setMsg("Payment canceled."); },
        onError: function(){ setMsg("Please try again."); }
      });
    }).catch(() => {
      setMsg("Please try again.");
    });
  });
})();
</script>
</body>
</html>
