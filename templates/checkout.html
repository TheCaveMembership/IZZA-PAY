<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Checkout — IZZA PAY</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <script src="https://sdk.minepi.com/pi-sdk.js"></script>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;background:#0b0f17;color:#e8f0ff;margin:0}
    .wrap{max-width:720px;margin:0 auto;padding:20px}
    .card{background:#0f1728;border:1px solid #1f2a44;border-radius:14px;padding:16px}
    .btn{background:#6e9fff;color:#0b0f17;border:0;border-radius:10px;padding:12px 16px;font-weight:800;cursor:pointer}
    .muted{color:#bcd0ff}
    .err{color:#ff9f9f}
    img.logo{max-height:36px}
    .row{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
  </style>
</head>
<body>
<div class="wrap">

  {% if sold_out %}
    <div class="card"><p class="err">Sorry, this item is sold out.</p></div>
  {% else %}
    <div class="card">
      <div class="row">
        {% if i.logo_url %}<img class="logo" src="/uimg?src={{ i.logo_url|urlencode }}" alt="logo">{% endif %}
        <h3 style="margin:0">Pay with Pi — {{ i.business_name }}</h3>
      </div>
      <p class="muted">Item: <strong>{{ i.title }}</strong>{% if qty %} &times; {{ qty }}{% endif %}</p>
      <p class="muted">Amount due: <strong>{{ '%.7f'|format(expected_pi) }} Pi</strong></p>
      <button class="btn" id="payBtn">Pay with Pi</button>
      <div id="status" class="muted" style="margin-top:10px"></div>
      <div id="error" class="err" style="margin-top:10px"></div>
    </div>
  {% endif %}

</div>

<script>
(function(){
  const sessionId = "{{ session_id }}";
  const expectedPi = {{ expected_pi|round(7) }};
  const cartMode = {{ 'true' if cart_mode else 'false' }};
  const isSandbox = {{ 'true' if PI_SANDBOX else 'false' }};

  const statusEl = document.getElementById('status');
  const errorEl  = document.getElementById('error');
  const payBtn   = document.getElementById('payBtn');

  function setStatus(msg){ if(statusEl) statusEl.textContent = msg || ''; }
  function setError(msg){ if(errorEl) errorEl.textContent = msg || ''; }

  // Initialize SDK
  if (!window.Pi) {
    setError('Pi SDK not available. Please open this page in the Pi Browser.');
  } else {
    try { Pi.init({ version: "2.0", sandbox: isSandbox }); } catch(e){ console.warn(e); }
  }

  async function postJSON(url, body){
    const r = await fetch(url, {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify(body || {})
    });
    return r;
  }
  async function getJSON(url){
    const r = await fetch(url, {method:'GET', headers:{'Accept':'application/json'}});
    return r;
  }

  // Polling fallback — if user closes the sheet, we still detect PAID
  let pollTimer = null;
  function startPolling(){
    stopPolling();
    let tries = 0;
    pollTimer = setInterval(async ()=>{
      tries++;
      try{
        const r = await getJSON(`/api/session/${sessionId}/status`);
        const data = await r.json().catch(()=>({}));
        if (r.ok && data.ok){
          if (data.state === 'paid' && data.redirect_url){
            window.location.replace(data.redirect_url);
          }
        }
      }catch(e){ /* ignore */ }
      if (tries > 60) stopPolling(); // ~2 minutes if you change to 2s interval
    }, 2000);
  }
  function stopPolling(){ if(pollTimer){ clearInterval(pollTimer); pollTimer = null; } }

  async function openPi(){
    if (!window.Pi) { setError('Pi SDK not available. Please use the Pi Browser.'); return; }
    setError(''); setStatus('Opening Pi payment…');

    const scopes = ['payments','username'];

    function onIncompletePaymentFound(payment) {
      // If Pi reports one, we’ll just poll server for state and let complete/redirect happen.
      startPolling();
    }

    Pi.authenticate(scopes, onIncompletePaymentFound)
      .then(async function(auth){
        const user = auth.user;
        const paymentData = {
          amount: expectedPi,
          memo: cartMode ? "Cart purchase via IZZA PAY" : "Order via IZZA PAY",
          metadata: { session_id: sessionId }
        };

        const payment = await Pi.createPayment(paymentData, {
          onReadyForServerApproval: async function(paymentId) {
            setStatus('Waiting for server approval…');
            startPolling(); // begin polling in case the close button is used
            const r = await postJSON('/api/pi/approve', { paymentId, session_id: sessionId });
            if(!r.ok){ setError('Approval failed.'); setStatus(''); }
          },
          onReadyForServerCompletion: async function(paymentId, txid) {
            setStatus('Completing payment…');
            const buyer = { name: user?.username || '', email: '' };
            const shipping = {};
            const r = await postJSON('/api/pi/complete', {
              paymentId, session_id: sessionId, txid, buyer, shipping
            });
            const data = await r.json().catch(()=>({}));
            if(r.ok && data.ok && data.redirect_url){
              stopPolling();
              window.location.replace(data.redirect_url);  // replace history to avoid back to checkout
            } else {
              // Don’t show failure; let polling detect the paid state shortly after.
              setStatus('Waiting for network confirmation…');
              startPolling();
            }
          },
          onCancel: function() {
            setError('Payment cancelled.');
            setStatus('');
            stopPolling();
          },
          onError: function(error) {
            console.error(error);
            setError('Payment error. Please try again.');
            setStatus('');
            stopPolling();
          }
        });

        await payment.open();

      })
      .catch(function(err){
        console.error(err);
        setError('Authorization failed. Please try again.');
        setStatus('');
      });
  }

  if(payBtn){ payBtn.addEventListener('click', openPi); }
})();
</script>
</body>
</html>
