<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Checkout</title>
  <script src="https://sdk.minepi.com/pi-sdk.js"></script>
</head>
<body>
  <h1>Checkout</h1>

  <form id="checkout-form">
    <label for="email">Email (for receipt & tracking):</label><br>
    <input type="email" id="email" name="email" required><br><br>

    <label for="address">Shipping Address:</label><br>
    <textarea id="address" name="address"></textarea><br><br>

    <label for="name">Full Name:</label><br>
    <input type="text" id="name" name="name"><br><br>

    <button type="button" id="pay-with-pi">Pay with Pi</button>
  </form>

  <script>
    const payButton = document.getElementById("pay-with-pi");

    payButton.addEventListener("click", async () => {
      const email = document.getElementById("email").value.trim();
      const address = document.getElementById("address").value.trim();
      const name = document.getElementById("name").value.trim();

      // Require email
      if (!email) {
        alert("Please enter your email before proceeding.");
        return;
      }

      try {
        const paymentData = {
          amount: localStorage.getItem("cart_total"),
          memo: "IzzaPay Purchase",
          metadata: { email, address, name },
        };

        const payment = await window.Pi.createPayment(paymentData, {
          onReadyForServerApproval: (paymentId) => {
            fetch("/approve_payment", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ paymentId, email, address, name }),
            });
          },
          onReadyForServerCompletion: (paymentId, txid) => {
            fetch("/complete_payment", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ paymentId, txid, email, address, name }),
            });
          },
          onCancel: (paymentId) => {
            console.log("Payment cancelled", paymentId);
          },
          onError: (error, paymentId) => {
            console.error("Payment error", error, paymentId);
          },
        });

        console.log("Payment created", payment);
      } catch (err) {
        console.error("Error creating payment", err);
      }
    });
  </script>
</body>
</html>
