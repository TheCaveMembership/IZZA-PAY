<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Checkout</title>
  <script src="https://sdk.minepi.com/pi-sdk.js"></script>
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const payBtn = document.getElementById("payWithPi");
      payBtn.addEventListener("click", async () => {
        try {
          const paymentData = {
            amount: {{ total }},
            memo: "Purchase from {{ merchant.name }}",
            metadata: { cart: {{ cart|tojson }} },
          };

          const payment = await Pi.createPayment(paymentData, {
            onReadyForServerApproval: (paymentId) => {
              fetch(`/approve_payment/${paymentId}`, { method: "POST" });
            },
            onReadyForServerCompletion: (paymentId, txid) => {
              fetch(`/complete_payment/${paymentId}`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ txid }),
              }).then(() => {
                alert("Payment complete!");
                window.location.href = "{{ merchant.store_url }}";
              });
            },
            onCancel: (paymentId) => {
              console.log("Payment cancelled", paymentId);
            },
            onError: (error, paymentId) => {
              console.error("Payment error", error, paymentId);
            },
          });
        } catch (err) {
          console.error("Payment initiation failed", err);
        }
      });
    });
  </script>
</head>
<body>
  <h1>Checkout</h1>
  <p>Total: {{ total }} Pi</p>
  <button id="payWithPi">Pay with Pi</button>
</body>
</html>
