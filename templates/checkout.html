<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Checkout — IZZA PAY</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <script src="https://sdk.minepi.com/pi-sdk.js"></script>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;background:#0b0f17;color:#e8f0ff;margin:0}
    .wrap{max-width:720px;margin:0 auto;padding:20px}
    .card{background:#0f1728;border:1px solid #1f2a44;border-radius:14px;padding:16px}
    .btn{background:#6e9fff;color:#0b0f17;border:0;border-radius:10px;padding:12px 16px;font-weight:800;cursor:pointer}
    .muted{color:#bcd0ff}
    .err{color:#ff9f9f}
    img.logo{max-height:36px}
    .row{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
  </style>
</head>
<body>
<div class="wrap">

  {% if sold_out %}
    <div class="card">
      <p class="err">Sorry, this item is sold out.</p>
    </div>
  {% else %}
    <div class="card">
      <div class="row">
        {% if i.logo_url %}<img class="logo" src="/uimg?src={{ i.logo_url|urlencode }}" alt="logo">{% endif %}
        <h3 style="margin:0">Pay with Pi — {{ i.business_name }}</h3>
      </div>
      <p class="muted">Item: <strong>{{ i.title }}</strong>{% if qty %} &times; {{ qty }}{% endif %}</p>
      <p class="muted">Amount due: <strong>{{ '%.7f'|format(expected_pi) }} Pi</strong></p>
      <button class="btn" id="payBtn">Pay with Pi</button>
      <div id="status" class="muted" style="margin-top:10px"></div>
      <div id="error" class="err" style="margin-top:10px"></div>
    </div>
  {% endif %}

</div>

<script>
(function(){
  const sessionId = "{{ session_id }}";
  const expectedPi = {{ expected_pi|round(7) }};
  const cartMode = {{ 'true' if cart_mode else 'false' }};

  const scopes = ['payments','username'];
  const statusEl = document.getElementById('status');
  const errorEl  = document.getElementById('error');
  const payBtn   = document.getElementById('payBtn');

  function setStatus(msg){ if(statusEl) statusEl.textContent = msg || ''; }
  function setError(msg){ if(errorEl) errorEl.textContent = msg || ''; }

  async function postJSON(url, body){
    const r = await fetch(url, {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify(body || {})
    });
    return r;
  }

  function openPi(){
    setError('');
    setStatus('Opening Pi payment…');

    function onIncompletePaymentFound(payment) {
      // Incomplete found -> try to complete anyway (user might have approved already)
      tryComplete(payment);
    }

    Pi.authenticate(scopes, onIncompletePaymentFound)
      .then(async function(auth){
        const user = auth.user;
        const paymentData = {
          amount: expectedPi,
          memo: cartMode ? "Cart purchase via IZZA PAY" : "Order via IZZA PAY",
          metadata: { session_id: sessionId }
        };

        // Create payment
        const payment = await Pi.createPayment(paymentData, {
          onReadyForServerApproval: async function(paymentId) {
            setStatus('Waiting for server approval…');
            const r = await postJSON('/api/pi/approve', { paymentId, session_id: sessionId });
            if(!r.ok){
              setError('Approval failed.'); setStatus('');
            }
          },
          onReadyForServerCompletion: async function(paymentId, txid) {
            setStatus('Completing payment…');
            const buyer = { name: user?.username || '', email: '' };   // (optional email)
            const shipping = {};                                        // (optional shipping)
            const r = await postJSON('/api/pi/complete', {
              paymentId, session_id: sessionId, txid, buyer, shipping
            });
            const data = await r.json().catch(()=>({}));
            if(r.ok && data.ok && data.redirect_url){
              setStatus('Done! Redirecting…');
              window.location.href = data.redirect_url;   // <<< GO BACK TO STORE WITH SUCCESS=1
            }else{
              setError('Could not confirm payment. ' + (data && data.error ? data.error : ''));
              setStatus('');
            }
          },
          onCancel: function(paymentId) {
            setError('Payment cancelled.');
            setStatus('');
          },
          onError: function(error, payment) {
            console.error(error);
            setError('Payment error. Please try again.');
            setStatus('');
          }
        });

        await payment.open(); // open Pi browser flow

      })
      .catch(function(err){
        console.error(err);
        setError('Authorization failed. Please try again.');
        setStatus('');
      });
  }

  if(payBtn){ payBtn.addEventListener('click', openPi); }
})();
</script>
</body>
</html>
