<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Sign in with Pi — IZZA PAY</title>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
  <link rel="stylesheet" href="/static/themes.css">
  <style>
    html,body{max-width:100%;overflow-x:hidden;}
    body{font-family:Arial,Helvetica,sans-serif;background:var(--bg);color:var(--txt);margin:0}
    .wrap{max-width:980px;margin:0 auto;padding:16px}
    @media (min-width:640px){ .wrap{padding:24px} }
    .topbar{
      display:flex;align-items:center;justify-content:space-between;gap:8px;flex-wrap:wrap;
      padding:8px 0; position:sticky; top:0; z-index:10;
      background:rgba(11,15,23,.9); backdrop-filter:blur(8px); border-bottom:1px solid var(--line);
    }
    .brand{display:flex;align-items:center;gap:10px;min-width:0}
    .brand img{height:24px}
    .actions{display:flex;gap:8px;flex-wrap:wrap}
    .actions a{white-space:nowrap}

    .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:16px}
    .pillrow{display:flex;gap:8px;flex-wrap:wrap;margin:10px 0 16px}
    h1{margin:0 0 8px;font-size:28px;line-height:1.15}
    p{color:var(--muted);margin:6px 0}
    .muted{color:var(--muted)}
    .hero-actions{display:flex;gap:10px;flex-wrap:wrap}

    /* Dropdown panel */
    .dropdown{
      position:relative;
      display:inline-block;
    }
    .menu{
      display:none;
      position:absolute;
      top:40px; left:0; min-width:320px; max-width:90vw;
      background:var(--card); border:1px solid var(--line); border-radius:12px;
      box-shadow:0 10px 30px rgba(0,0,0,.35);
      padding:12px; z-index:20;
    }
    .menu.show{ display:block; }
    .section{ margin:6px 0 10px; }
    .section h3{ margin:4px 0 6px; font-size:14px; color:var(--muted) }
    .row{ display:flex; gap:8px; justify-content:space-between; align-items:center; border-top:1px solid var(--line); padding:8px 0 }
    .small{ font-size:12px; color:var(--muted) }
    .mono{ font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace; }
    .tight{ margin-top:4px }
    .right{ text-align:right }
    .link{ color:var(--txt); text-decoration:underline }
  </style>
  <script src="https://sdk.minepi.com/pi-sdk.js"></script>
</head>
<body class="cw-blue theme-a">
  <div class="wrap">
    <!-- Top bar -->
    <div class="topbar">
      <div class="brand">
        <img src="/static/izzapay-mark.svg" alt="IZZA mark">
        <img src="/static/izzapay-word.svg" alt="IZZA PAY">
      </div>
      <div class="actions">
        <a class="ip-btn ghost" href="/explore">Browse Stores</a>
        <a class="ip-btn ghost" href="/privacy">Privacy</a>
      </div>
    </div>

    <!-- Sign-in card -->
    <div class="card" style="margin-top:12px">
      <h1>Sign in with Pi</h1>
      <p>Create your merchant store, add products, and accept Pi in minutes.</p>

      <div class="pillrow">
        <span class="ip-pill">1% app fee</span>
        <span class="ip-pill">99% to merchant</span>
        <span class="ip-pill">Pi SDK v2</span>
      </div>

      <div class="hero-actions">
        <button id="piSignInBtn" class="ip-btn">Authorize with Pi</button>

        <!-- New: View my orders dropdown -->
        <div class="dropdown">
          <button id="viewOrdersBtn" class="ip-btn ghost">View my orders</button>
          <div id="ordersMenu" class="menu">
            <div id="menuContent">
              <div class="small">Sign in with Pi to load your orders…</div>
            </div>
          </div>
        </div>

        <a class="ip-btn ghost" href="/explore">See Stores</a>
      </div>

      <p id="msg" class="muted"></p>
      <div id="err" style="color:#ff9aa2;white-space:pre-wrap"></div>
    </div>

    <!-- How it works -->
    <div class="card" style="margin-top:14px">
      <ol style="margin:0;padding-left:18px">
        <li style="margin:8px 0">
          <strong>Authorize with Pi.</strong>
          <span class="muted">You’ll stay inside the Pi Browser.</span>
        </li>
        <li style="margin:8px 0">
          <strong>Create your store &amp; add products.</strong>
          <span class="muted">Upload images, set prices, and pick a theme and fonts.</span>
        </li>
        <li style="margin:8px 0">
          <strong>Share your store link.</strong>
          <span class="muted">Customers sign in with Pi and pay instantly.</span>
        </li>
      </ol>
    </div>
  </div>

  <script>
  (function(){
    const btn = document.getElementById('piSignInBtn');
    const ordersBtn = document.getElementById('viewOrdersBtn');
    const menu = document.getElementById('ordersMenu');
    const menuContent = document.getElementById('menuContent');
    const msg = document.getElementById('msg');
    const err = document.getElementById('err');
    const sandbox = {{ 'true' if sandbox else 'false' }};

    function setMsg(t){ if(msg){ msg.textContent = t || ''; } }
    function setErr(t){ if(err){ err.textContent = t || ''; } }

    function initPi(){
      if (!window.Pi || !Pi.init) return false;
      try { Pi.init({ version: "2.0", sandbox: sandbox }); return true; }
      catch(e){ console.error("Pi.init failed", e); setErr("Pi.init failed: " + (e?.message || e)); return false; }
    }
    if (!initPi()) setMsg("Open in Pi Browser or refresh. (Pi SDK not ready)");

    // --- Existing "Authorize with Pi" -> sets server session (dashboard flow)
    btn?.addEventListener('click', function(){
      setErr('');
      if (!window.Pi || !Pi.authenticate) { setMsg("Pi SDK not available. Open in Pi Browser or refresh."); return; }
      setMsg("Requesting authorization…");
      const scopes = ['payments','username'];
      function onIncompletePaymentFound(payment){ /* optional resume */ }
      Pi.authenticate(scopes, onIncompletePaymentFound)
        .then(function(auth){
          // Post to /auth/exchange (form) to establish session & redirect to dashboard
          const form = document.createElement('form');
          form.method = 'POST'; form.action = "/auth/exchange";
          const inp = document.createElement('input');
          inp.type='hidden'; inp.name='payload';
          inp.value = JSON.stringify({ accessToken: auth.accessToken, user: auth.user });
          form.appendChild(inp); document.body.appendChild(form); form.submit();
        })
        .catch(function(e){ console.error(e); setMsg("Authorization failed. Please try again."); setErr(e?.message || String(e)); });
    });

    // --- NEW: Orders dropdown flow
    function toggleMenu(show){
      if (show === undefined){
        menu.classList.toggle('show');
      } else {
        if (show) menu.classList.add('show'); else menu.classList.remove('show');
      }
    }
    document.addEventListener('click', (ev)=>{
      if (!menu.contains(ev.target) && ev.target !== ordersBtn){
        toggleMenu(false);
      }
    });

    ordersBtn?.addEventListener('click', async function(){
      setErr('');
      toggleMenu(true);
      menuContent.innerHTML = '<div class="small">Authorizing with Pi…</div>';

      if (!window.Pi || !Pi.authenticate){
        menuContent.innerHTML = '<div class="small">Pi SDK not available. Open this in Pi Browser.</div>';
        return;
      }

      try{
        const scopes = ['payments','username'];
        function onIncompletePaymentFound(payment){}
        const auth = await Pi.authenticate(scopes, onIncompletePaymentFound);

        // Exchange for server token (JSON) — we added "token" in the response.
        const j = await fetch("/auth/exchange", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ accessToken: auth.accessToken, user: auth.user })
        }).then(r => r.json());

        const token = j && (j.token || ((j.redirect||'').split('t=').pop())) || '';
        if(!token){
          menuContent.innerHTML = '<div class="small">Could not obtain token. Please try again.</div>';
          return;
        }

        // Fetch orders with bearer token (as query)
        const orders = await fetch("/api/my-orders?t=" + encodeURIComponent(token)).then(r => r.json());
        if(!orders || !orders.ok){
          menuContent.innerHTML = '<div class="small">No orders or not authorized.</div>';
          return;
        }

        // Build dropdown content
        const purchases = Array.isArray(orders.purchases) ? orders.purchases : [];
        const sales     = Array.isArray(orders.sales) ? orders.sales : [];

        function row(r){
          const amt = (Number(r.amount)||0).toFixed(7) + ' π';
          const tx  = r.pi_tx_hash ? String(r.pi_tx_hash).slice(0,8) + '…' : '—';
          return `
            <div class="row">
              <div>
                <div><strong>${r.title || 'Item'}</strong></div>
                <div class="small tight mono">#${r.id} • qty ${r.qty} • ${r.status || 'paid'}</div>
              </div>
              <div class="right">
                <div>${amt}</div>
                <div class="small mono tight">${tx}</div>
              </div>
            </div>
          `;
        }

        let html = '';
        html += `<div class="section"><h3>Purchases (${purchases.length})</h3>`
             +  (purchases.length ? purchases.slice(0,8).map(row).join('') : `<div class="small">No purchases yet.</div>`)
             +  `</div>`;

        if (sales.length){
          html += `<div class="section"><h3>Sales (${sales.length})</h3>`
               +   sales.slice(0,8).map(row).join('')
               +  `</div>`;
        }else{
          html += `<div class="section"><h3>Sales</h3><div class="small">Create a store to receive sales.</div></div>`;
        }

        // Link to dashboard if merchant
        html += `<div class="section"><a class="link small" href="/dashboard">Open dashboard</a></div>`;

        menuContent.innerHTML = html;

      }catch(e){
        console.error(e);
        menuContent.innerHTML = '<div class="small">Authorization failed. Please try again.</div>';
      }
    });
  })();
  </script>
</body>
</html>
