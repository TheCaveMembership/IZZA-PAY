<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Sign in with Pi — IZZA PAY</title>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
  <link rel="stylesheet" href="/static/themes.css">
  <style>
    html,body{max-width:100%;overflow-x:hidden;}
    body{font-family:Arial,Helvetica,sans-serif;background:var(--bg);color:var(--txt);margin:0}
    .wrap{max-width:980px;margin:0 auto;padding:16px}
    @media (min-width:640px){ .wrap{padding:24px} }
    .topbar{
      display:flex;align-items:center;justify-content:space-between;gap:8px;flex-wrap:wrap;
      padding:8px 0; position:sticky; top:0; z-index:10;
      background:rgba(11,15,23,.9); backdrop-filter:blur(8px); border-bottom:1px solid var(--line);
    }
    .brand{display:flex;align-items:center;gap:10px;min-width:0}
    .brand img{height:24px}
    .actions{display:flex;gap:8px;flex-wrap:wrap}
    .actions a{white-space:nowrap}

    .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:16px}
    .pillrow{display:flex;gap:8px;flex-wrap:wrap;margin:10px 0 16px}
    h1{margin:0 0 8px;font-size:28px;line-height:1.15}
    p{color:var(--muted);margin:6px 0}
    .muted{color:var(--muted)}
    .hero-actions{display:flex;gap:10px;flex-wrap:wrap}
    details{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:10px}
    summary{cursor:pointer;font-weight:800}
    .list{margin-top:8px;border-top:1px solid var(--line)}
    .row{display:flex;gap:8px;align-items:center;justify-content:space-between;border-bottom:1px solid var(--line);padding:8px 0}
    .row small{color:var(--muted)}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
    .right{text-align:right}
    .empty{color:var(--muted);font-style:italic;padding:6px 2px}
  </style>
  <script src="https://sdk.minepi.com/pi-sdk.js"></script>
</head>
<body class="cw-blue theme-a">
  <div class="wrap">
    <!-- Top bar -->
    <div class="topbar">
      <div class="brand">
        <img src="/static/izzapay-mark.svg" alt="IZZA mark">
        <img src="/static/izzapay-word.svg" alt="IZZA PAY">
      </div>
      <div class="actions">
        <a class="ip-btn ghost" href="/explore">Browse Stores</a>
        <a class="ip-btn ghost" href="/privacy">Privacy</a>
      </div>
    </div>

    <!-- Sign-in card -->
    <div class="card" style="margin-top:12px">
      <h1>Sign in with Pi</h1>
      <p>Create your merchant store, add products, and accept Pi in minutes.</p>

      <div class="pillrow">
        <span class="ip-pill">1% app fee</span>
        <span class="ip-pill">99% to merchant</span>
        <span class="ip-pill">Pi SDK v2</span>
      </div>

      <div class="hero-actions">
        <button id="piSignInBtn" class="ip-btn">Authorize with Pi</button>
        <button id="viewOrdersBtn" class="ip-btn ghost">View my orders</button>
        <a class="ip-btn ghost" href="/explore">See Stores</a>
      </div>

      <p id="msg" class="muted"></p>
      <div id="err" style="color:#ff9aa2;white-space:pre-wrap"></div>
    </div>

    <!-- Orders (appears after auth) -->
    <div id="ordersCard" class="card" style="margin-top:12px; display:none">
      <h2 style="margin:0 0 8px">Your orders</h2>
      <p class="muted" style="margin:0 0 10px">Shown for your Pi username.</p>

      <div id="ordersContent">
        <!-- Filled by JS -->
      </div>
    </div>

    <!-- How it works -->
    <div class="card" style="margin-top:14px">
      <ol style="margin:0;padding-left:18px">
        <li style="margin:8px 0">
          <strong>Authorize with Pi.</strong>
          <span class="muted">You’ll stay inside the Pi Browser.</span>
        </li>
        <li style="margin:8px 0">
          <strong>Create your store &amp; add products.</strong>
          <span class="muted">Upload images, set prices, and pick a theme and fonts.</span>
        </li>
        <li style="margin:8px 0">
          <strong>Share your store link.</strong>
          <span class="muted">Customers sign in with Pi and pay instantly.</span>
        </li>
      </ol>
    </div>
  </div>

  <script>
  (function(){
    const btn = document.getElementById('piSignInBtn');
    const viewBtn = document.getElementById('viewOrdersBtn');
    const msg = document.getElementById('msg');
    const err = document.getElementById('err');
    const ordersCard = document.getElementById('ordersCard');
    const ordersContent = document.getElementById('ordersContent');
    const postUrl = "/auth/exchange";
    const sandbox = {{ 'true' if sandbox else 'false' }};

    function setMsg(t){ if(msg){ msg.textContent = t || ''; } }
    function setErr(t){ if(err){ err.textContent = t || ''; } }

    function initPi(){
      if (!window.Pi || !Pi.init) return false;
      try { Pi.init({ version: "2.0", sandbox: sandbox }); return true; }
      catch(e){ console.error("Pi.init failed", e); setErr("Pi.init failed: " + (e?.message || e)); return false; }
    }
    if (!initPi()) setMsg("Open in Pi Browser or refresh. (Pi SDK not ready)");

    // --- Normal sign-in -> server redirect to dashboard ---
    btn?.addEventListener('click', function(){
      setErr('');
      if (!window.Pi || !Pi.authenticate) { setMsg("Pi SDK not available. Open in Pi Browser or refresh."); return; }
      setMsg("Requesting authorization…");
      const scopes = ['payments','username'];
      function onIncompletePaymentFound(payment){ /* optional resume */ }
      Pi.authenticate(scopes, onIncompletePaymentFound)
        .then(function(auth){
          const form = document.createElement('form');
          form.method = 'POST'; form.action = postUrl;
          const inp = document.createElement('input');
          inp.type='hidden'; inp.name='payload';
          inp.value = JSON.stringify({ accessToken: auth.accessToken, user: auth.user });
          form.appendChild(inp); document.body.appendChild(form); form.submit();
        })
        .catch(function(e){ console.error(e); setMsg("Authorization failed. Please try again."); setErr(e?.message || String(e)); });
    });

    // --- Inline "View my orders" flow (no navigation) ---
    async function authThenLoadOrders(){
      setErr(''); setMsg('Authorizing…');
      if (!window.Pi || !Pi.authenticate) { setMsg("Pi SDK not available. Open in Pi Browser or refresh."); return; }
      const scopes = ['payments','username'];
      function onIncompletePaymentFound(){}

      try{
        const auth = await Pi.authenticate(scopes, onIncompletePaymentFound);

        // Exchange token via JSON (keeps you on this page, sets session cookie)
        const ex = await fetch('/auth/exchange', {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify({ accessToken: auth.accessToken, user: auth.user }),
          credentials: 'same-origin'
        }).then(r=>r.json());

        if (!ex || !ex.ok){
          setMsg("Could not complete sign-in."); setErr((ex && ex.error) || 'Unknown error'); return;
        }

        // Now session is set, fetch orders
        setMsg('Loading your orders…');
        const j = await fetch('/api/my-orders', { credentials: 'same-origin' }).then(r=>r.json());
        if (!j || !j.ok){ setMsg(''); setErr((j && j.error) || 'Failed to load orders'); return; }

        // Render
        ordersCard.style.display = '';
        renderOrders(j);
        setMsg('');
      }catch(e){
        console.error(e);
        setMsg('Authorization failed.'); setErr(e?.message || String(e));
      }
    }

    viewBtn?.addEventListener('click', authThenLoadOrders);

    function fmtPi(x){
      try{ return Number(x).toFixed(7) + ' π'; }catch(_){ return x + ' π'; }
    }
    function esc(s){ return String(s||'').replace(/[&<>"]/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;' }[c])); }

    function renderOrders(data){
      const purchases = Array.isArray(data.purchases) ? data.purchases : [];
      const sales     = Array.isArray(data.sales) ? data.sales : [];

      const section = (title, rows, kind) => {
        if (!rows.length){
          return `<details open><summary>${esc(title)}</summary><div class="empty">No ${kind} yet.</div></details>`;
        }
        const list = rows.map(r => `
          <div class="row">
            <div>
              <div><strong>${esc(r.title || r.item_title || 'Item')}</strong></div>
              <small>${kind==='purchases'
                ? `from ${esc(r.merchant_name || r.m_name || '')}`
                : `qty ${esc(r.qty)} • buyer ${esc(r.buyer_username || r.buyer_email || '—')}`}</small>
            </div>
            <div class="right">
              <div>${fmtPi(r.pi_amount || r.amount || r.total || 0)}</div>
              <small class="mono">#${esc(r.id)}</small>
            </div>
          </div>
        `).join('');
        return `<details open><summary>${esc(title)}</summary><div class="list">${list}</div></details>`;
      };

      ordersContent.innerHTML =
        section('Purchases', purchases, 'purchases') +
        section('Sales', sales, 'sales');
    }
  })();
  </script>
</body>
</html>
