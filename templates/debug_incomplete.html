<!doctype html>
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Find & Cancel Incomplete Pi Payment</title>
<style>
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;padding:16px;background:#0b0f17;color:#e8f0ff}
  .card{background:#0f1728;border:1px solid #1f2a44;border-radius:12px;padding:16px;max-width:640px;margin:0 auto}
  button{padding:10px 14px;border:0;border-radius:10px;background:#6e9fff;color:#0b0f17;font-weight:800;cursor:pointer}
  input{width:100%;padding:10px;border:1px solid #1f2a44;border-radius:10px;background:#0b1222;color:#e8f0ff}
  .muted{color:#bcd0ff}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
</style>
<div class="card">
  <h2>Find & Cancel Incomplete Payment</h2>
  <p class="muted">Open this page <strong>in Pi Browser</strong>.</p>
  <p class="muted">Token ends with: <code>{{ (token[-6:] if token|length > 6 else token) }}</code></p>

  <div id="status" class="muted">Loading Pi SDK…</div>

  <div id="found" style="display:none;margin-top:12px">
    <div class="row" style="align-items:flex-end">
      <div style="flex:1">
        <label class="muted">Payment ID</label>
        <input id="pid" readonly>
      </div>
      <div>
        <button id="cancelBtn">Cancel payment</button>
      </div>
    </div>
    <p class="muted" style="margin-top:8px">If cancel succeeds, you can retry checkout immediately.</p>
  </div>

  <div id="none" style="display:none;margin-top:12px">
    <p>No incomplete payment was reported by the Pi SDK.</p>
  </div>
</div>

<script src="https://sdk.minepi.com/pi-sdk.js"></script>
<script>
(async function(){
  const status = document.getElementById('status');
  const found  = document.getElementById('found');
  const none   = document.getElementById('none');
  const pidEl  = document.getElementById('pid');
  const btn    = document.getElementById('cancelBtn');

  function set(t){ status.textContent = t; }
  function qs(k){ return new URL(location.href).searchParams.get(k) || ''; }

  const token = qs('token');

  try{
    if(!window.Pi || !Pi.init){ set("Pi SDK not available. Open in Pi Browser."); return; }
    Pi.init({ version: "2.0" });

    let stuckId = null;
    const scopes = ['payments','username'];
    function onIncompletePaymentFound(payment){
      stuckId = (payment && (payment.identifier || payment.paymentId)) || null;
    }

    set("Authenticating…");
    await Pi.authenticate(scopes, onIncompletePaymentFound);

    if(stuckId){
      set("Incomplete payment detected.");
      pidEl.value = stuckId;
      found.style.display = '';
      btn.onclick = async () => {
        btn.disabled = true; btn.textContent = "Cancelling…";
        try{
          const url = `/debug/cancel-payment?token=${encodeURIComponent(token)}&payment_id=${encodeURIComponent(stuckId)}`;
          const r = await fetch(url);
          const j = await r.json();
          if(j && j.ok){
            set("Cancelled. You can retry checkout now.");
          }else{
            set("Cancel failed. See server logs."); console.log(j);
          }
        }catch(e){
          set("Cancel request errored. See logs."); console.error(e);
        }finally{
          btn.disabled = false; btn.textContent = "Cancel payment";
        }
      };
    }else{
      set("No incomplete payment detected.");
      none.style.display = '';
    }
  }catch(e){
    set("Error: " + (e && e.message || e));
    console.error(e);
  }
})();
</script>
