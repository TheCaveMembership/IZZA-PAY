html = """
<!doctype html>
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Find & Fix Incomplete Pi Payment</title>
<style>
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;padding:16px;background:#0b0f17;color:#e8f0ff}
  .card{background:#0f1728;border:1px solid #1f2a44;border-radius:12px;padding:16px;max-width:760px;margin:0 auto}
  button{padding:10px 14px;border:0;border-radius:10px;background:#6e9fff;color:#0b0f17;font-weight:800;cursor:pointer}
  button[disabled]{opacity:.6;cursor:wait}
  input,textarea{width:100%;padding:10px;border:1px solid #1f2a44;border-radius:10px;background:#0b1222;color:#e8f0ff}
  textarea{min-height:140px;font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace}
  .muted{color:#bcd0ff}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .btns{display:flex;gap:10px;margin-top:8px;flex-wrap:wrap}
  .ok{color:#7fe39b}
  .err{color:#ff8a8a}
  pre{white-space:pre-wrap;word-break:break-word;background:#0b1222;border:1px solid #1f2a44;border-radius:8px;padding:10px;max-height:220px;overflow:auto}
</style>
<div class="card">
  <h2>Find & Fix Incomplete Payment</h2>
  <p class="muted">Open this page <strong>in Pi Browser</strong>.</p>
  <p class="muted">Token ends with: <code id="tok"></code></p>

  <div id="status" class="muted">Loading Pi SDK…</div>

  <div id="found" style="display:none;margin-top:12px">
    <div class="row" style="align-items:flex-end">
      <div style="flex:1">
        <label class="muted">Payment ID</label>
        <input id="pid" readonly>
      </div>
    </div>

    <div class="btns">
      <button id="cancelBtn">Cancel (app→user)</button>
      <button id="completeBtn">Complete (user→app)</button>
      <button id="retryBtn" type="button">Re-check</button>
    </div>

    <div style="margin-top:10px" id="out"></div>
  </div>

  <div id="none" style="display:none;margin-top:12px">
    <p>No incomplete payment was reported by the Pi SDK.</p>
    <div class="btns"><button id="retryBtn2" type="button">Re-check</button></div>
  </div>

  <div style="margin-top:12px">
    <label class="muted">Raw object from onIncompletePaymentFound</label>
    <textarea id="raw" readonly placeholder="(nothing yet)"></textarea>
  </div>
</div>

<script src="https://sdk.minepi.com/pi-sdk.js"></script>
<script>
(async function(){
  const status = document.getElementById('status');
  const found  = document.getElementById('found');
  const none   = document.getElementById('none');
  const pidEl  = document.getElementById('pid');
  const cancelBtn   = document.getElementById('cancelBtn');
  const completeBtn = document.getElementById('completeBtn');
  const retryBtn    = document.getElementById('retryBtn');
  const retryBtn2   = document.getElementById('retryBtn2');
  const out    = document.getElementById('out');
  const rawEl  = document.getElementById('raw');
  const tokEl  = document.getElementById('tok');

  function set(t){ status.textContent = t; }
  function qs(k){ return new URL(location.href).searchParams.get(k) || ''; }
  function show(ok, title, payload){
    out.innerHTML = '';
    const h = document.createElement('div');
    h.className = ok ? 'ok' : 'err';
    h.textContent = title;
    const pre = document.createElement('pre');
    try{ pre.textContent = typeof payload === 'string' ? payload : JSON.stringify(payload, null, 2); }
    catch(e){ pre.textContent = String(payload); }
    out.appendChild(h); out.appendChild(pre);
  }
  function showRaw(obj){
    try{ rawEl.value = obj ? JSON.stringify(obj, null, 2) : ''; }catch(_){}
  }

  const token = qs('token'); tokEl.textContent = token ? token.slice(-6) : '';

  let stuck = null, stuckId = null;

  async function run(){
    found.style.display = 'none'; none.style.display = 'none'; out.innerHTML = ''; showRaw(null);
    try{
      if(!window.Pi || !Pi.init){ set("Pi SDK not available. Open in Pi Browser."); return; }
      Pi.init({ version: "2.0" });

      function onIncompletePaymentFound(payment){
        stuck = payment || null;
        showRaw(stuck);
        stuckId = (stuck && (stuck.identifier || stuck.paymentId)) || null;
      }

      set("Authenticating…");
      await Pi.authenticate(['payments','username'], onIncompletePaymentFound);
      if(stuckId){
        set("Incomplete payment detected.");
        pidEl.value = stuckId; found.style.display = '';
      }else{
        set("No incomplete payment detected."); none.style.display = '';
      }
    }catch(e){
      set("Error: " + (e && e.message || e));
      console.error(e);
    }
  }

  retryBtn.onclick = run; if(retryBtn2) retryBtn2.onclick = run;

  cancelBtn.onclick = async ()=>{
    if(!stuckId) return;
    cancelBtn.disabled = true; cancelBtn.textContent = "Cancelling…";
    try{
      const r = await fetch(`/debug/cancel-payment?token=${encodeURIComponent(token)}&payment_id=${encodeURIComponent(stuckId)}`);
      const j = await r.json(); show(!!j.ok, "Cancel response", j);
    }catch(e){ show(false, "Cancel error", String(e)); }
    finally{ cancelBtn.disabled = false; cancelBtn.textContent = "Cancel (app→user)"; }
  };

  completeBtn.onclick = async ()=>{
    if(!stuckId) return;
    completeBtn.disabled = true; completeBtn.textContent = "Completing…";
    try{
      const r = await fetch(`/debug/complete-payment?token=${encodeURIComponent(token)}&payment_id=${encodeURIComponent(stuckId)}`);
      const j = await r.json(); show(!!j.ok, "Complete response", j);
    }catch(e){ show(false, "Complete error", String(e)); }
    finally{ completeBtn.disabled = false; completeBtn.textContent = "Complete (user→app)"; }
  };

  run();
})();
</script>
"""
