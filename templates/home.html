<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>IZZA PAY — Pay with Pi for any store</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="stylesheet" href="/static/themes.css">
  <style>
    .wrap{max-width:1080px;margin:0 auto;padding:16px}
    .hero{display:flex;gap:18px;align-items:center;justify-content:space-between;flex-wrap:wrap;margin-top:8px}
    .brand{display:flex;align-items:center;gap:12px}
    .brand img{height:40px}
    h1{margin:0;font-size:1.8rem}
    .lead{color:var(--muted);margin:6px 0 0}
    .cta{display:flex;gap:12px;flex-wrap:wrap;margin-top:14px}
    .btn{background:var(--brand);color:#0b0f17;border:0;border-radius:12px;padding:12px 16px;font-weight:900;cursor:pointer;text-decoration:none}
    .ghost{background:transparent;border:1px solid var(--line);color:var(--txt)}
    .card{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:16px;margin-top:16px}
    .search{display:flex;gap:8px}
    .search input{flex:1;background:#0b1222;border:1px solid var(--line);border-radius:12px;color:var(--txt);padding:12px}
    .subtle{color:var(--muted)}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:12px;margin-top:12px}
    .store{border:1px solid var(--line);border-radius:14px;background:#0b1222;padding:12px}
    .row{display:flex;align-items:center;gap:10px}
    .logo{height:40px;width:40px;border-radius:10px;overflow:hidden;border:1px solid var(--line);background:#0b1222;display:flex;align-items:center;justify-content:center}
    .logo img{max-width:100%;max-height:100%}
    .small{font-size:.92rem}
    .right{margin-left:auto}
    .hidden{display:none}
  </style>
</head>
<body data-color="blue">
  <div class="wrap">
    <!-- Top hero -->
    <div class="hero">
      <div>
        <div class="brand">
          <img src="/static/izzapay-logo.svg" alt="IZZA PAY">
          <h1>Accept &amp; pay with Pi — anywhere</h1>
        </div>
        <p class="lead">Create a branded Pi storefront in minutes. Generate “Pay with Pi” buttons for your website.</p>
        <div class="cta">
          <!-- Sign in with Pi (merchant) -->
          <form action="/auth/exchange" method="post" id="signinForm">
            <input type="hidden" name="payload" id="payload">
            <button class="btn" type="submit">Sign in with Pi (Create your store)</button>
          </form>
          <button class="btn ghost" id="toggleStores">Browse stores</button>
          <a class="btn ghost" href="/explore">Explore all</a>
        </div>
      </div>
      <img src="/static/izzapay-mark.svg" alt="IZZA PAY mark" style="height:88px;opacity:.9">
    </div>

    <!-- Global search -->
    <div class="card">
      <form class="search" action="/explore" method="get">
        <input type="search" name="q" placeholder="Search stores and products across IZZA PAY…">
        <button class="btn" type="submit">Search</button>
      </form>
      <p class="subtle small" style="margin-top:8px">Tip: Merchants can link their IZZA PAY store from any website menu or product page.</p>
    </div>

    <!-- Store list (collapsible) -->
    <div class="card hidden" id="storeListCard">
      <div class="row" style="justify-content:space-between;margin-bottom:8px">
        <strong>Featured Stores</strong>
        <a class="small subtle" href="/explore">See all →</a>
      </div>
      {% if stores and stores|length > 0 %}
      <div class="grid">
        {% for m in stores %}
        <div class="store">
          <div class="row">
            <div class="logo">
              {% if m.logo_url %}
              <img src="{{ m.logo_url }}" alt="{{ m.business_name }}">
              {% else %}
              <img src="/static/izzapay-mark.svg" alt="Logo">
              {% endif %}
            </div>
            <div>
              <div style="font-weight:800">{{ m.business_name }}</div>
              <div class="subtle small">@{{ m.slug }}</div>
            </div>
            <a class="btn right" href="/store/{{ m.slug }}">Visit</a>
          </div>
          {% if m.description %}
          <p class="subtle small" style="margin:10px 0 0">{{ m.description[:140] }}{% if m.description|length > 140 %}…{% endif %}</p>
          {% endif %}
        </div>
        {% endfor %}
      </div>
      {% else %}
      <p class="subtle">No stores yet. Be the first to launch your Pi storefront!</p>
      {% endif %}
    </div>
  </div>

  <!-- Pi SDK -->
  <script src="https://sdk.minepi.com/pi-sdk.js"></script>
  <script>
    (function(){
      const stores = document.getElementById('storeListCard');
      const toggleStores = document.getElementById('toggleStores');
      toggleStores?.addEventListener('click', ()=> stores.classList.toggle('hidden'));

      // Initialize Pi and bind sign-in
      try {
        const sandbox = {{ 'true' if PI_SANDBOX else 'false' }};
        const appId   = "{{ PI_APP_ID or '' }}";
        if (window.Pi && Pi.init) { Pi.init({version:"2.0", sandbox:sandbox, appId:appId}); }
      } catch(e){ console.warn('Pi.init failed', e); }

      const scopes = ['payments','username'];
      const form = document.getElementById('signinForm');
      form?.addEventListener('submit', async (e) => {
        e.preventDefault();
        try{
          const auth = await Pi.authenticate(scopes, ()=>{});
          document.getElementById('payload').value = JSON.stringify({
            accessToken: auth.accessToken,
            user: auth.user
          });
          form.submit();
        }catch(err){
          alert('Please open in Pi Browser and try again.');
          console.error(err);
        }
      });
    })();
  </script>
</body>
</html>
